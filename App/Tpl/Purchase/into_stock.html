<form id="stock_in_form">
    <input type="hidden" name="purchase_id" value="{$purchase['purchase_id']}">
    <input type="hidden" name="type" value="{$purchase['type']}">
    <input type="hidden" name="sn">
    <table class="table table-bordered" id="no-input-border" width="95%">
        <tr>
            <td colspan="9">
                <div class="pull-left" style="width: 50%;">入库仓&#12288;
                    <select name="warehouse_id" class="form-control" style="display: inline-block;width: 250px;">
                        <volist name="warehouse" id="vo">
                            <option value="{$vo['warehouse_id']}">{$vo['name']}</option>
                        </volist>
                    </select>
                </div>
                <div class="pull-right" style="line-height: 100%;">本次入库数设为0表示此商品暂不入库&#12288;
                    <!-- <input type="submit" class="btn btn-primary" value="入库"> -->
                </div>
            </td>
        </tr>
        <tr style="background-color:#f9fafc;text-align:center;">
            <td style="background-color:#f9fafc;padding:14px;color:#999">产品名称</td>
            <td style="background-color:#f9fafc;padding:14px;color:#999">规格</td>
            <td style="background-color:#f9fafc;padding:14px;color:#999">单位</td>
            <td style="background-color:#f9fafc;padding:14px;color:#999">订单数</td>
            <?php if ($has_return > 0) { ?>
                <td style="background-color:#f9fafc;padding:14px;color:#999">退货数</td>
            <?php } ?>
            <td style="background-color:#f9fafc;padding:14px;color:#999">已入库数</td>
            <td style="background-color:#f9fafc;padding:14px;color:#999">待入库数</td>
            <td style="background-color:#f9fafc;padding:14px;color:#999">本次入库数</td>
            <td style="background-color:#f9fafc;padding:14px;color:#999">备注</td>
        </tr>
        <volist name="product_info_list" id="vo" key="k">
            <tr>
                <td style="text-align:center;padding:14px;color:#666">{$vo.name}</td>
                <td style="text-align:center;padding:14px;color:#666">{$vo['spec']['string']}</td>
                <td style="text-align:center;padding:14px;color:#666">{$vo.standard}</td>
                <td style="text-align:center;padding:14px;color:#666">{$vo.count}</td>
                <?php if ($has_return > 0) { ?>
                <td style="text-align:center;padding:14px;color:#666">{$vo.return_count}</td>
                <?php } ?>
                <td style="text-align:center;padding:14px;color:#666">{$vo.stock_in_count}</td>
                <td style="text-align:center;padding:14px;color:#666" class="surplus">{$vo['count'] + $vo['return_count'] - $vo['stock_in_count']}</td>
                <td style="text-align:center;padding:14px;color:#666">
                    <?php if($vo['has_sn']) { ?>
                    <input type="hidden" name="list[{$vo.product_info_id}][sn]">
                    <a href="javascript:void(0);" class="select_SN" rel="{$vo.product_info_id}" name="{$vo.name}({$vo['spec']['string']})">
                        <span class="label label-success">SN</span>
                    </a>
                    <input type="number" min="0" max="{$vo['count'] + $vo['return_count'] - $vo['stock_in_count']}" class="stock_in_count form-control" name="list[{$vo.product_info_id}][count]" value="0" style="width: 100px; height: 27px; display: inline-block;padding: 3px 0!important; cursor: pointer;" readonly> &nbsp;&nbsp;{$vo.standard}
                    <?php } else { ?>
                    <input type="number" min="0" max="{$vo['count'] + $vo['return_count'] - $vo['stock_in_count']}" class="stock_in_count form-control" name="list[{$vo.product_info_id}][count]" value="0" style="width: 100px; height: 27px; display: inline-block;padding: 3px 0!important;"> &nbsp;&nbsp;{$vo.standard}
                    <?php } ?>
                </td>
                <td style="text-align:center;padding:14px;color:#666">
                    <input type="text" class="form-control" name="list[{$vo.product_info_id}][remark]"
                    style="width: 100px; height: 27px; display: inline-block;padding: 3px 0!important;">
                </td>
            </tr>
        </volist>
        <tr>
            <td colspan="9">
                <div style="margin: 10px 0;">
                    <div style="width: 45%;display: inline-block;">入库日期&#12288;
                        <input type="text" class="form-control Wdate" style="display: inline-block;width: 250px;" name="create_time" value="{:date('Y-m-d')}"
                            onfocus="WdatePicker({dateFmt:'yyyy-MM-dd'})" required>
                    </div>
                    <div style="width: 45%;display: inline-block;">入库单号&#12288;
                        <input class="form-control" style="display: inline-block;width: 250px;" type="text" name="number" value="{$number}"
                            required />
                    </div>
                </div>
                <div>
                    <div style="width: 45%;display: inline-block;">经办人&#12288;&#12288;
                        <select name="owner_role_id" class="form-control select2" style="display: inline-block;width: 250px;">
                            <volist name="role_list" id="vo">
                                <option value="{$vo['role_id']}">{$vo['full_name']}</option>
                            </volist>
                        </select>
                    </div>
                    <div style="width: 45%;display: inline-block;">备注&#12288;&#12288;&#12288;
                        <input class="form-control" style="display: inline-block;width: 250px;" type="text" name="remark" placeholder="填写备注" />
                    </div>
                </div>
            </td>
        </tr>
    </table>
</form>
<div style="display:none" id="dialog-select-SN" title="SN码管理">
    <div class="spiner-example">
        <div class="sk-spinner sk-spinner-three-bounce">
            <div class="sk-bounce1"></div>
            <div class="sk-bounce2"></div>
            <div class="sk-bounce3"></div>
        </div>
    </div>
</div>
<script>
    $('.stock_in_count').on('blur', function () {
        var count = $(this).val();
        var surplus = $(this).parents('tr').find('.surplus').html();
        if (Number(count) > Number(surplus)) {
            swal('超出待入库数', '待入库：' + surplus, 'warning');
            $(this).val(Number(surplus));
        } else if (Number(count) < 0) {
            swal('最小值为0', '', 'warning');
            $(this).val(0);
        }
    });
    $('#dialog-select-SN').dialog({
        autoOpen: false,
        modal: true,
        width: 800,
        maxHeight: 600,
        position: ["center", 80],
        buttons: {
            "确认": function () {
                var count = Number($('#SN_count').html());
                var surplus = Number($('#SN_select_surplus').html());
                var product_info_id = $('#select_SN_form input[name="product_info_id"]').val();
                if (count > surplus) {
                    swal('选择SN码数量超过待入库数量！', '待入库数' + surplus + ',超出' +  (count - surplus), 'warning');
                    return false;
                }
                SN_arr = [];
                $('#select_SN_form input.SN:checked').each(function (key, val) {
                    SN_arr.push($(val).val());
                });
                $('input[name="list[' + product_info_id + '][sn]"]').val(SN_arr);
                $('input[name="list[' + product_info_id + '][count]"]').val(SN_arr.length);
                $(this).dialog("close");
            },
            "取消": function () {
                $(this).dialog("close");
            }
        },
        close: function() {
            $(this).html('');
        }
    });
    $('.select_SN').on('click', function () {
        //id="purchase_type"元素在父页面 purchase_type 1 采购单 2销售退货单
        var purchase_type = $('#purchase_type').val();
        var product_info_id = $(this).attr('rel');
        var name = $(this).attr('name');
        var surplus = $(this).parents('tr').find('.surplus').html();
        var sn_ids = $('input[name="list[' + product_info_id + '][sn]"]').val();
        $('#dialog-select-SN').dialog('open');
        if (purchase_type == 2) {
            $('#dialog-select-SN').load('{:U("sales/out_sn_select")}&product_info_id=' + product_info_id + '&name=' + encodeURIComponent(name) + '&surplus=' + surplus + '&sn_ids=' + sn_ids + '&sales_id=' + '{$purchase["type_id"]}');
        } else {
            var has_return = '{$has_return}';
            $('#dialog-select-SN').load('{:U("Purchase/stockInSn")}&product_info_id=' + product_info_id + '&name=' + encodeURIComponent(name) + '&surplus=' + surplus + '&sn_ids=' + sn_ids + '&has_return=' + has_return);
        }
    });
    $('.stock_in_count').on('click', function () {
        $(this).parents('td').find('.select_SN').click();
    });
</script>