<include file="Public:header" />
<style>
    .nav.nav-tabs-left li{width:100%;}
    .nav-tabs-left>li.active>a{border-top:white;color: #19aa8d !important;background-color:#fff;}
    .table>tbody>tr>td{border-top:0px;}
    .table>tfoot>tr>td{border-top:0px;}
    #main_pic_prev{width: 38px;height: 38px;border: 1px dashed #d3d3d6;}
    .table tbody tr {cursor: Default;}
    #tpl_module_add_option_tb tr {line-height: 40px;}
</style>
<script src="__PUBLIC__/js/PCASClass.js" type="text/javascript"></script>
<link href="__PUBLIC__/style/css/plugins/cropper/cropper.min.css" rel="stylesheet">
<script src="__PUBLIC__/style/js/plugins/cropper/cropper.min.js"></script>
<script src="__PUBLIC__/style/js/plugins/nice-scroll/jquery.nicescroll.min.js" type="text/javascript"></script>

<script>
$(function(){
    $(".add_body").height(window.innerHeight-$("#add_body").offset().top-$("#tfoot_div").height()-40);
    $(window).resize(function(){
        $(".add_body").height(window.innerHeight-$("#add_body").offset().top-$("#tfoot_div").height()-40);
    })
})
</script>
<link rel="stylesheet" href="__PUBLIC__/css/jquery.fileupload.css" type="text/css" />
<div class="wrapper wrapper-content animated fadeIn">
    <include file="Public:alert" />
    <div class="row">
        <div class="col-lg-12">
            <include file="Setting:setting_left" />
            <div class="col-sm-10" >
                <div class="ibox-content add_body" id="add_body">
                    <div class="row">
                        <div class="col-md-12  add_body" >
                            <div class="full-height-scroll">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th colspan="2">
                                                <a <php>echo ($action == 'index') ? 'href="javascript:void(0)" class="active"' : 'href="'.U('template/index').'"'</php>>模板管理</a> &nbsp;&nbsp;
                                                <if condition="0">
                                                    <a <php>echo ($action == 'object') ? 'href="javascript:void(0)" class="active"' : 'href="'.U('template/object').'"'</php>>对象管理</a> &nbsp;&nbsp;
                                                    <a <php>echo ($action == 'field') ? 'href="javascript:void(0)" class="active"' : 'href="'.U('template/field').'"'</php>>字段管理</a> &nbsp;&nbsp;
                                                </if>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="form-inline" >
                                                 <div class="form-group">
                                                    <form id="object">
                                                        <span>对象选择：&nbsp;</span>
                                                        <select id="tpl_module" class="form-control">
                                                            <option value="0">全部</option>
                                                            <volist name="object" id="vo">
                                                                <option value="{$vo.id}">{$vo.name}</option>
                                                            </volist>
                                                        </select>
                                                    </form>
                                                </div>
                                            </td>
                                            <td>
                                                <button id="add" class="btn btn-primary pull-right">新建</button>
                                            </td>
                                        </tr>
                                        <table class="table table-striped table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>模板名称</th>
                                                    <th>对象</th>
                                                    <th>创建人</th>
                                                    <th>创建时间</th>
                                                    <th>修改时间</th>
                                                    <th>状态</th>
                                                    <th>操作</th>
                                                </tr>
                                                <tr id="tpl_model" hidden>
                                                    <td class="tpl_title"></td>
                                                    <td class="tpl_object"></td>
                                                    <td class="tpl_creator"></td>
                                                    <td class="tpl_create_time"></td>
                                                    <td class="tpl_update_time"></td>
                                                    <td class="tpl_status" style="padding-left: 25px;">
                                                        <div class="radio radio-info radio-inline" style="margin-right: 10px;">
                                                            <input type="radio" class="indexShow" value="1"><label val="1">启用</label>
                                                        </div>
                                                        <div class="radio radio-info radio-inline">
                                                            <input type="radio" class="indexShow" value="0"><label val="0">停用</label>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <a class="tpl_edit" tplid="" >编辑</a>&nbsp;&nbsp;
                                                        <a class="tpl_reset" tplid="" href="" disabled>初始化</a>&nbsp;&nbsp;
                                                        <a class="tpl_delete" tplid="" href="" disabled>删除</a>
                                                    </td>
                                                </tr>
                                            </thead>
                                            <tbody id="tpl_container"></tbody>
                                        </table>                                      
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="clear:both;" ></div>
        </div>
    </div>
</div>
<div class="" style="display:none;" id="dialog_field_add_option"></div>
<script type="text/javascript" src="__PUBLIC__/js/uploadPreview.js"></script>
<script type="text/javascript">
    var edit_page,add_page;
    $(function(){
        $("#dialog_field_add_option").dialog({
            autoOpen: false,
            modal: true,
            width: 500,
            maxHeight: 800,
            position: ["center",100],
            buttons: {
                "确认": function () {
                    var option = $("#tpl_module_add_option_form").serializeArray();
                    var parStr = '&object_id=' + option[0]['value'];
                    if (option.length == 2) {
                        parStr += '&is_copy=0';
                    }else {
                        parStr += '&is_copy=1&tpl_id=' + option[2]['value'];
                    }
                    add_page = layer.open({
                        type: 2,
                        title: '模板预览',
                        shadeClose: true,
                        area: ['100%', '100%'],
                        content: '{:U("template/add")}' + parStr//iframe的url
                    }); 
                    $('.layui-layer-title,.layui-layer-close').remove();
                    
                    $(this).dialog("close");
                },
                "{:L('CANCEL')}": function () {
                    $(this).dialog("close");
                }
            }
        });
        init(0);
        function init(id) {
            $.ajax({
                url: '{:U("template/ajax_get_template")}',
                type: 'POST',
                data: {object: id},
                dataType: 'JSON',
                success: function(json){
                    var data = json.data;
                    if (json.msg != '') {
                        layer.msg(json.msg);
                        return false;
                    }
                    if (data != null) {
                        $('#tpl_container').html('');
                        $.each(data, function(k, v){
                            var model = $("#tpl_model").clone();
                            model.prop('hidden', false);
                            var system = '';
                            if (v.system == '1') {
                                system = '<span class="label label-primary">系统</span>&nbsp;&nbsp;';
                            }
                            model.find('.tpl_title').html(system + v.title);
                            model.find('.tpl_object').html(v.object_name);
                            model.find('.tpl_creator').html(v.creator_name);
                            model.find('.tpl_create_time').html(v.create_time);
                            model.find('.tpl_update_time').html(v.update_time);
                            model.find('.tpl_status').find('input').attr('name', 'tpl_status_'+ v.template_id);
                            model.find('.tpl_status').find('[value="'+ v.status +'"]').prop('checked', true);
                            model.find('.tpl_status').find('[value="1"]').attr('id', 'tpl_status_'+ k +'_'+ 1);
                            model.find('.tpl_status').find('[val="1"]').attr('for', 'tpl_status_'+ k +'_'+ 1);
                            model.find('.tpl_status').find('[value="0"]').attr('id', 'tpl_status_'+ k +'_'+ 0);
                            model.find('.tpl_status').find('[val="0"]').attr('for', 'tpl_status_'+ k +'_'+ 0);
                            model.find('.tpl_status').find('input').on('change', function(){
                                status_update($(this));
                            });
                            model.find('.tpl_edit').attr('tplid', v.template_id);
                            model.find('.tpl_edit').on('click', function(){
                                var id = $(this).attr('tplid');
                                edit_page = layer.open({
                                    type: 2,
                                    title: '模板预览',
                                    shadeClose: true,
                                    area: ['100%', '100%'],
                                    content: '{:U("template/edit?template_id=")}' + id//iframe的url
                                }); 
                                $('.layui-layer-title,.layui-layer-close').remove();
                                return false;
                            });
                            model.find('.tpl_reset').attr('tplid', v.template_id);
                            model.find('.tpl_reset').on('click', function(){
                                var id = $(this).attr('tplid');
                                swal({ 
                                    title: "确定初始化吗？", 
                                    text: "初始化后无法恢复该数据！", 
                                    type: "warning",
                                    showCancelButton: true, 
                                    confirmButtonColor: "#DD6B55",
                                    confirmButtonText: "确定", 
                                    cancelButtonText: "取消",
                                    closeOnConfirm: false, 
                                    closeOnCancel: false  
                                },
                                function(isConfirm){ 
                                    if (isConfirm) {
                                        $.ajax({
                                        url: '{:U("template/ajax_reset")}',
                                        data: {id: id},
                                        type: 'POST',
                                        dataType: 'JSON',
                                        success: function(json){
                                            if(json.status == 1) {
                                                swal(json.msg, "", "success");
                                            } else if (json.status == 3) {
                                                swal(json.msg, "", "error"); 
                                            } else if (json.status == 7) {
                                                swal(json.msg, "", "warning"); 
                                            }
                                        },
                                        beforeSend: function(){
                                            layer.load();
                                        },
                                        complete: function(){
                                            layer.closeAll('loading');
                                        }
                                    });
                                    } else { 
                                        swal("已经取消。", "", "success"); 
                                    } 
                                });
                                return false;
                            });
                            model.find('.tpl_delete').attr('tplid', v.template_id);
                            model.find('.tpl_delete').on('click', function(){
                                var id = $(this).attr('tplid');
                                swal({ 
                                    title: "确定删除吗？", 
                                    text: "删除后无法恢复该数据！", 
                                    type: "warning",
                                    showCancelButton: true, 
                                    confirmButtonColor: "#DD6B55",
                                    confirmButtonText: "确定！", 
                                    cancelButtonText: "取消！",
                                    closeOnConfirm: false, 
                                    closeOnCancel: false  
                                },
                                function(isConfirm){ 
                                    if (isConfirm) {
                                        $.ajax({
                                        url: '{:U("template/delete")}',
                                        data: {id: id},
                                        type: 'POST',
                                        dataType: 'JSON',
                                        success: function(json){
                                            if(json.status == 1) {
                                                swal(json.msg, "", "success");
                                                window.location.reload();
                                            } else if (json.status == 2) {
                                                swal(json.msg, "", "error"); 
                                            }
                                        },
                                        beforeSend: function(){
                                            layer.load();
                                        },
                                        complete: function(){
                                            layer.closeAll('loading');
                                        }
                                    });
                                    } else { 
                                        swal("已经取消。", "", "success"); 
                                    } 
                                });
                                return false;
                            });
                            if (v.system == '1') {
                                model.find('.tpl_delete').remove();
                            }
                            $('#tpl_container').append(model);
                        });
                    }
                }
            });
        }
        // 
        function status_update(inp) {
            var data = new Object();
            data['template_id'] = inp.attr('name').split('_')[2];
            data['status'] = inp.val();
            $.ajax({
                url: '{:U("template/status_update")}',
                data: data,
                type: 'POST',
                dataType: 'JSON',
                success: function(json){
                    var status = (json.status == 1) ? 'success' : 'error';
                    swal(json.msg, '', status);
                },
                beforeSend: function(){
                    layer.load();
                },
                complete: function(){
                    layer.closeAll('loading');
                }
            });
        }

        // 添加模板
        $("#add").click(function(){
            $("#dialog_field_add_option").dialog('open');
            $("#dialog_field_add_option").load('{:U("template/option")}');
        });
        // 条件选择
        $("#object").find('select').on('change', function(){
            init($(this).val());
        });
    });
    var my_reload = function() {
        location.reload();
    }

</script>
<include file="Public:footer" />    