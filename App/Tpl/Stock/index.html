<include file="Public:header" />
<link href="__PUBLIC__/css/litebox.css" rel="stylesheet" type="text/css">
<script src="__PUBLIC__/js/PCASClass.js" type="text/javascript"></script>
<!-- nice-scroll -->
<script src="__PUBLIC__/style/js/plugins/nice-scroll/jquery.nicescroll.min.js" type="text/javascript"></script>
<script type="text/javascript" src="__PUBLIC__/style/js/TableFreeze.js"></script>
<script src="__PUBLIC__/js/pdcrm_more.js" type="text/javascript"></script>
<style>
	body{
		overflow-y: hidden;
	}
	.option{padding-left:-30px;}
	#oDivL_tab_Test3{background-color: #fff;}
	.dynamic_input {
		width: 80px;
		margin-right: -80px;
	}
	/*悬浮提示信息框样式*/
	.fa-info-circle {
		font-size: 16px;
		color: rgb(249, 94, 0);
		cursor: pointer;
	}
	.popover {
	 	color: rgb(249, 94, 0);
	}
	/*悬浮提示信息框样式*/
</style>
<script>
$(function(){
	var scroll_width = 10;
	$("#table_div").height(window.innerHeight-$("#table_div").offset().top-$("#tfoot_div").height()-parseInt($("#table_container").css("padding-bottom").replace("px",""))-10);
	$(window).resize(function(){
		$("#table_div").height(window.innerHeight-$("#table_div").offset().top-$("#tfoot_div").height()-parseInt($("#table_container").css("padding-bottom").replace("px",""))-10);
		$("#oDivL_tab_Test3").height($("#table_div").height()-scroll_width-1).width($("#oTableLH_tab_Test3").width());
		$("#oDivH_tab_Test3").height($("#oTableLH_tab_Test3").height()).width($("#table_div").width()-scroll_width);
	});
	$(".nicescroll").niceScroll({
		cursorcolor: "#999",//#CC0071 光标颜色 
	    cursoropacitymax: 0.4, //改变不透明度非常光标处于活动状态（scrollabar“可见”状态），范围从1到0 
	    touchbehavior: false, //使光标拖动滚动像在台式电脑触摸设备 
	    cursorwidth: scroll_width+"px", //像素光标的宽度 
	    cursorborder: "0", //     游标边框css定义 
	    cursorborderradius: "3px",//以像素为光标边界半径 
	    autohidemode: false, //是否隐藏滚动条 
	    zindex:100,
	    background:"#F3F3F5",//滚动条背景色
	});
	$("#tab_Test3").FrozenTable(1,0,2);
	$("#oDivL_tab_Test3").height($("#table_div").height()-scroll_width-1).width($("#oTableLH_tab_Test3").width()).css({'zIndex':9});
	$("#oDivL_tab_Test3").css({"background-color":"#fff","border-right":"1px solid #e7eaec"});
	$("#oTableLH_tab_Test3").css({"border-right":"1px solid #e7eaec"});
	$("#oDivH_tab_Test3").height($("#oTableLH_tab_Test3").height()).width($("#table_div").width()-scroll_width).css({'zIndex':9});
})
</script>
<div class="wrapper wrapper-content">
	<include file="Public:alert" />
    <div class="row">
        <div class="col-md-12">
            <div class="ibox float-e-margins"> 
				<div class="title-bar" style="position: relative;z-index: 99;">
					<div class="row  clearfix" id="title-hide" style="display:none;">
						<ul class="breadcrum pull-left">
							<li>已选中&nbsp;<span id="icheck_num"></span>&nbsp;项</li>
							<li class="last_li"><big><a class="fa fa-times pull-right" id="back-show"></a></big></li>
							<li><a href="javascript:void(0);" class="link excelExport" type="id"><i class="fa fa-download"></i>&nbsp;导出</a></li>
						</ul>
					</div>
					<div class="row" id="title-show">
						
						<form class="form-inline" id="form_search" action="" method="get">
							<input type="hidden" name="m" value="stock"/>
							<input type="hidden" name="a" value="index"/>
							<input type="hidden" name="act" value=""/>
							<input type="hidden" name="ids" value=""/>
							<input type="hidden" name="this_page" value="{$this_page}" />
							<div class="btn-group pull-right" style="margin-right: 20px;">
								<button data-toggle="dropdown" class="btn btn-primary dropdown-toggle" aria-expanded="true">操作 <span class="caret"></span>
								</button>
								<ul class="dropdown-menu">
									<!-- <li><a id="import_excel" class="link" href="javascript:void(0);"><i class="fa fa-upload"></i>&nbsp;导入</a></li> -->
									<li><a href="javascript:void(0);" class="link excelExport"><i class="fa fa-download"></i>&nbsp;导出</a></li>
									<!-- <li><a href="javascript:void(0);" class="link sendsms"><i class="fa fa-comments-o"></i>&nbsp;发送短信</a></li> -->
								</ul>
							</div>
							<div class="nav navbar-top-links navbar-left pull-right" style="margin: 0 15px 0 -10px;">
								<div class="dropdown" style="">
									<a title="排序" href="javascript:void(0)" data-toggle="dropdown" class="btn btn-white btn-bitbucket dropdown-toggle"
									 style="margin-left:-4px;"><i class="fa fa-sort-amount-asc" style="color: #D8E3EF;"></i></a>
									<ul class="dropdown-menu dropdown-menu-left" style="width:150px;left:-100px;" id='dropdown_order'>
										<li class="list-group" role="presentation" style="height:50px;">
											<div class="full-height-scroll" data-height="50px" data-plugin="slimScroll" style="overflow: hidden; height: 50px; width: auto;margin-top:10px;">
												<div class="link-block" style="margin-left:15px;">
													<div class="radio radio-info radio-inline">
														<input type="radio" class="save_order" name="order_field" value="count" <if
														 condition="$_GET['order_field'] eq 'count' || $_GET['order_field'] eq ''">checked</if>>
														<label for="count_order">
															库存量
														</label>
													</div>
												</div>
											</div>
										</li>
										<li class="divider" style="height:1px;"></li>
										<li>
											<div class="link-block" style="margin-left:15px;">
												<div class="radio radio-info radio-inline">
													<input type="radio" class="save_order" name="order_type" id="asc_order" value="asc" <if condition="$_GET['order_type'] eq 'asc'">checked</if>>
													<label for="asc_order">
														正序
													</label>
												</div>
											</div>
											<div class="link-block" style="margin-left:15px;">
												<div class="radio radio-info radio-inline">
													<input type="radio" class="save_order" name="order_type" id="desc_order" value="desc" <if condition="$_GET['order_type'] eq 'desc' || $_GET['order_type'] eq ''">checked</if>>
													<label for="desc_order">
														倒序
													</label>
												</div>
											</div>
											<div class="link-block" style="margin-left:15px;">
												<div class="radio radio-info radio-inline">
													<input type="radio" class="save_order" name="order_type" id="cancel_order" value="" <if condition="!$_GET['order_type']">checked</if>>
													<label for="cancel_order">
														默认
													</label>
												</div>
											</div>
										</li>
									</ul>
								</div>
							</div>
							<ul class="breadcrum pull-right" style="margin-bottom: 0px">
								<li>
									<div class="input-group" style="margin-right: 10px;margin-bottom: 5px;">
										<select name="category_id" class="form-control" onchange="do_search($(this))">
											<option value="">全部分类</option>
											<volist name="category_list" id="vo">
												<option value="{$vo.category_id}" <if condition="$_GET['category_id'] eq $vo['category_id']">selected="selected"</if>>{$vo['name']}</option>
											</volist>
										</select>
									</div>
									<div class="input-group" style="margin-right: 10px;margin-bottom: 5px;">
										<select name="warehouse_id" class="form-control" onchange="do_search($(this))" >
											<option value="">全部仓库</option>
											<volist name="warehouse_list" id="vo">
												<option value="{$vo.warehouse_id}" <if condition="$_GET['warehouse_id'] eq $vo['warehouse_id']">selected="selected"</if>>{$vo['name']}</option>
											</volist>
										</select>
									</div>
									<div class="input-group" style="margin-right: 10px;margin-bottom: 5px;">
										<select name="filter_count" class="form-control" onchange="do_search($(this))">
											<option value="">库存数量(所有)</option>
											<option value="eq" <if condition="$_GET['filter_count'] eq 'eq'">selected</if>>库存数等于0</option>
											<option value="lt" <if condition="$_GET['filter_count'] eq 'lt'">selected</if>>库存数小于0</option>
											<option value="gt" <if condition="$_GET['filter_count'] eq 'gt'">selected</if>>库存数大于0</option>
										</select>
									</div>
									<div class="input-group" style="margin-right: 10px;margin-bottom: 5px;">
										<select name="over_range" class="form-control" onchange="do_search($(this))">
											<option value="">上下限(所有)</option>
											<option value="not" <if condition="$_GET['over_range'] eq 'not'">selected</if>>未达限</option>
											<option value="upper" <if condition="$_GET['over_range'] eq 'upper'">selected</if>>达到上限</option>
											<option value="lower" <if condition="$_GET['over_range'] eq 'lower'">selected</if>>达到下限</option>
											<option value="both" <if condition="$_GET['over_range'] eq 'both'">selected</if>>达到上、下限</option>
										</select>
									</div>
								</li>
								<li>
									搜索：
									<div class="input-group">
										<input id="short_search" type="text" style="width:210px;" placeholder="商品名称/编码/条形码/规格值" onkeydown='if(event.keyCode==13) {$("#short_search_btn").trigger("click");return false;}' class="form-control input-sm" name="search" <if condition = "$_GET['field'] eq 'name'">value="{$_GET['search']}"</if>/>	
										<span class="input-group-btn">
											<button class="btn btn-default btn-search" id="short_search_btn" type="submit"><i class="fa fa-search"></i></button>
										</span>
									</div>
									<!-- &nbsp;&nbsp;<a title="高级搜索" href="javascript:void(0)" id="search_type" class="btn btn-white btn-bitbucket"><i class="fa fa-filter" style="color: #D8E3EF;"></i></a> -->
								</li>
							</ul>
						</form>
					</div>
				</div>
				<div class="ibox-content clearfix" id="table_container" style="z-index: 1;">
					<form id="form1" action="" method="Post" style="position:relative;"> 
						<div id="table_div" class="nicescroll">
							<table class="table table-hover table-striped table_thead_fixed" id="tab_Test3">
								<if condition="$list eq null">
									<tr>
										<td style="background-color: #fff;"><include file="Public:nodata" /></td>
									</tr>
								<else/>
									<tr id="childNodes_num" class="tabTh">
										<td style="width:30px;padding-left: 20px">
											<div class="checkbox checkbox-primary">
												<input type="checkbox" class="check_all"/>
												<label for=""></label>
											</div>
										</td>
										<td>商品名称</td>
										<td>商品编码</td>
										<td>商品条形码</td>
										<td>规格</td>
										<td>单位</td>
										<td>所属仓库</td>
										<td>库存下限</td>
										<td>库存上限</td>
										<!-- <td title="库存调拨被调入量+采购数量，可理解为将入库数量">在途量</td>
										<td title="订单量">订单量</td> -->
										<td title="实际可用库存量，即总库存量-订单量">库存量</td>
									</tr>
									<volist name="list" id="vo">
										<tr class="controls_tr">
											<td style="width:30px;padding-left: 20px">
												<div class="checkbox checkbox-primary">
													<input name="stock_id[]" class="check_list" type="checkbox" value="{$vo.stock_id}" <if condition="$vo['check_per']">rel1="1"<else/>rel1="0"</if>/>
													<label for=""></label>
												</div>
											</td>
											<td>
												<a href="{:U('product/view','id='.$vo['product_id'].'#tab4')}">{$vo.product_name}</a>
											</td>
											<td>{$vo.number}</td>
											<td>{$vo.bar_code}</td>
											<td>
												{$vo['spec_list']['spec']}
												<if condition="$vo['state'] eq 1">
													<i class="fa fa-info-circle" data-trigger="hover" data-container="body" data-toggle="popover" data-placement="top" data-content="该产品已下架"></i>
												</if>
											</td>
											<td>{$vo.standard}</td>
											<td>
												{$vo.warehouse_name}
												<if condition="$vo['status'] eq 2">
													<i class="fa fa-info-circle" data-trigger="hover" data-container="body" data-toggle="popover" data-placement="top" data-content="该仓库已禁用"></i>
												</if>
											</td>
											<td class="dynamic_edit" field_name="lower_limit" rel="{$vo['lower_limit']}" title="双击可编辑" style="cursor: pointer;">
												{$vo.lower_limit}
											</td>
											<td class="dynamic_edit" field_name="upper_limit" rel="{$vo['upper_limit']}" title="双击可编辑" style="cursor: pointer;">
												{$vo.upper_limit}
											</td>
											<!-- <td>{$vo.purchase_count}</td>
											<td>{$vo.order_count}</td> -->
											<td>
												<if condition="$vo['over_range']">
													<b title="库存量超出范围" class="text-danger">{$vo.count}</b>
												<else />
													{$vo.count}
												</if>
											</td>
										</tr> 
									</volist>
								</if>
							</table>
						</div>
						<div id="tfoot_div" class="clearfix">
							<div class="clearfix" id="tfoot_page">
								<if condition="$fields_search">
									<span class="pull-left" style="margin-left:25px;margin-top:10px;">本次搜索结果<span style="color:#F8AC59"> {$count} </span>条数据<a href="{:U('stock/index')}" class="btn" style="background:#fff;border:1px solid #ccc;margin-left:10px;color:#999;" id="clearnumber">清除搜索条件</a></span>
								</if>
								{$page}<include file="Public:listrows" />
							</div>
						</div>
					</form>
				</div>
    		</div>
        </div>
    </div>
</div>

<div style="display:none" id="dialog-role-info" title="{:L('DIALOG_USER_INFO')}">
	<div class="spiner-example">
		<div class="sk-spinner sk-spinner-three-bounce">
			<div class="sk-bounce1"></div>
			<div class="sk-bounce2"></div>
			<div class="sk-bounce3"></div>
		</div>
	</div>
</div>
<script type="text/javascript">
	/*让复选框默认取消选择*/
	var is_receivables = '{$is_receivables}';
	$(':checkbox').prop('checked', false);

	$("#short_search").val('{$Think.get.search}');

	if ("{:C('isMobile')}" == "1") {
		width = $('#table_container').width() * 0.9;
	} else {
		width = 800;
	}

	$("#dialog-role-info").dialog({
	    autoOpen: false,
	    modal: true,
		width: width,
		maxHeight: 550,
		position: ["center",100]
	});
	$(".role_info").click(function(){
		$role_id = $(this).attr('rel');
		$('#dialog-role-info').dialog('open');
		$('#dialog-role-info').load('{:U("user/dialoginfo","id=")}'+$role_id);
	});

	//选择下拉列表后自动搜索
	function do_search(obj){
		var val = obj.val();
		$('#form_search').submit();
	}

	//双击编辑库存上下限
	$('.dynamic_edit').dblclick(function(){
		var stock_id = $(this).parent().children().find('.check_list').val();	
		var field_name = $(this).attr('field_name');
		var val = parseInt($(this).attr('rel'));
		$(this).html('<input type="hidden" name="stock_id" value="'+stock_id+'">\
			<input type="number" class="dynamic_input" name="'+field_name+'" value="'+val+'">\
		');
		$('.dynamic_input').focus();
	});
	//失去焦点时，保存数据
	$(document).on('blur','.dynamic_input',function(){
		var tthis = $(this);
		var val = tthis.val();
		$.ajax({
			type:'post',
			url:"{:U('stock/edit')}",
			data:$('#form1').serialize(),
			async:false,
			success:function(data){
				tthis.parent().html(val ? val : '-');
				if(data.status == 1){
					rtal(data.info, 'success');
				}else{
					rtal(data.info, 'error');
				}
			},
			error: function () {
				tthis.parent().html(val ? val : '-');
				rtal('您没有此权限！', 'error');
			},
			dataType:'json'
		});
	});

	// 排序
	$('input[name="order_type"]').on('change', function () {
		$('#form_search').submit();
	});

	// 导出
	$('.excelExport').on('click', function () {
		if ($(this).attr('type') == 'id') {
			let ids = [];
			$('.check_list').each(function (key, val) {
				if ($(val).is(':checked')) {
					ids.push($(val).val());
				}
			});
			$('#form_search [name="ids"]').val(ids.join(','));
		}
		$('#form_search [name="act"]').val('export');
		$('#form_search').submit();
		$('#form_search [name="act"]').val('');
	});
</script>
<include file="Public:footer" />