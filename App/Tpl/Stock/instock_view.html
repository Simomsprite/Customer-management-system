<include file="Public:header" />
<div class="wrapper wrapper-content animated fadeIn">
    <div class="row">
	    <div class="col-lg-12">
			<div class="title-bar">
				<div class="row " id="title-show">
					<ul class="nav pull-left" style="margin:0px 10px 0px 20px;">
						<span>
							<img src="__PUBLIC__/img/contract_view_icon.png" style="margin-bottom:9px;" alt="">
						</span>
						<span style="font-size:21px;margin-left:5px">&nbsp;&nbsp;&nbsp;{$purchase.number}</span>&nbsp;&nbsp; 
						<if condition="$purchase['is_checked'] eq 1">
							<span class="badge badge-success check_badge" style="padding:5px 20px;margin-top:-8px;background:#8BC34A;color:#fff;">通过</span>&nbsp;
						<elseif condition="$purchase['is_checked'] eq 2"/>
							<span class="badge badge-error check_badge" style="color:#fff;padding:5px 20px;margin-top:-8px;background:#F5715F">拒绝</span>&nbsp;
						<elseif condition="$purchase['is_checked'] eq 3"/>
							<span class="badge badge-error check_badge" style="color:#fff;padding:5px 20px;margin-top:-8px;background:#FF6600">审批中</span>&nbsp;
						<else />
							<span class="badge badge-warning" style="color:#fff;padding:5px 20px;margin-top:-8px;background:#F5CA00;">待审</span>
						</if>
					</ul>
					
					<if condition="$purchase['is_checked'] eq 0 || $purchase['is_checked'] eq 2">
						<a href="{:U('purchase/edit','id='.$purchase['purchase_id'])}" class="btn btn-outline btn-default pull-right" style="margin-right: 15px;"><i class="fa fa-pencil"></i>&nbsp;&nbsp;编辑</a>
					</if>
					<if condition="$purchase['is_checked'] eq 0 || $purchase['is_checked'] eq 3">
						<if condition = "$check_per">
							<a href="javascript:void(0);" id="check_purchase" style="margin-right:15px;" rel="{$purchase['purchase_id']}" class="btn btn-primary pull-right">审核</a>
						</if>
					</if>
					<if condition="$purchase['is_checked'] neq '0'">
						<if condition = "$re_check_per">
							<a href="javascript:void(0);" id="recheck_purchase" style="margin-right:15px;" rel="{$purchase['purchase_id']}" class="btn btn-primary pull-right">撤销</a>
						</if>
					</if>
					<a href="javascript:void(0);" id="print" class="btn btn-info pull-right" style="margin-right: 15px;"><i class="glyphicon glyphicon-print"></i>&nbsp;&nbsp;打印</a>
				</div>
			</div>
			<div class="tabs-container">
				<div class="pull-left" style="width:100%;" >
					<div class="ibox-content" style="padding:15px 0 0 20px;background:#fff;" id="left-content">
						<div class="tab-content ">
							<div class="tab-pane in active" id="tab1">
								<div class="panel-body">
									<include file="Public:alert" />
									<table class="table table-bordered" id="tab-detail" width="95%">
										<tr>
											<td colspan="7">
												仓库：华北一仓&#12288;&#12288;
												单号：L-20180525-151506&#12288;&#12288;
												入库日期：2018-05-25 10:40&#12288;&#12288;
												制单人：刘丹
											</td>
										</tr>
										<tr style="background-color:#f9fafc;text-align:center;">
											<td style="background-color:#f9fafc;padding:14px;color:#999">序号</td>
											<td style="background-color:#f9fafc;padding:14px;color:#999">产品编号</td>
											<td style="background-color:#f9fafc;padding:14px;color:#999">规格</td>
											<td style="background-color:#f9fafc;padding:14px;color:#999">产品名称</td>
											<td style="background-color:#f9fafc;padding:14px;color:#999">单位</td>
											<td style="background-color:#f9fafc;padding:14px;color:#999">入库数量</td>
											<td style="background-color:#f9fafc;padding:14px;color:#999">备注</td>
										</tr>										
										<tr style="text-align:center;padding:14px;color:#666">
											<td>1</td>
											<td>CP0001</td>
											<td>张小萌</td>
											<td>内存：8G，存储：64G</td>                                  
											<td>个</td>
											<td>100</td>
											<td>入库</td>
										</tr>
										<tr style="text-align:center;padding:14px;color:#666">
											<td>2</td>
											<td>CP0001</td>
											<td>王小萌</td>
											<td>内存：8G，存储：64G</td>                                  
											<td>个</td>
											<td>100</td>
											<td>入库</td>
										</tr>
										<tr>
											<td colspan="7">
												<div style="margin-bottom: 10px;">
													<div style="width: 45%;display: inline-block;">经办人：
														王小萌
													</div>
													<div style="width: 45%;display: inline-block;">关联采购单号：
														<a href="#">CG-20171212-000226</a>
													</div>
												</div>
												<div>
													<div style="width: 45%;display: inline-block;">备注：
														反恐军事反恐军事克利夫兰斯卡拉反击快乐世纪福克斯的
													</div>
												</div>
											</td>
										</tr>
									</table>

									<div style="font-size:13px;font-weight:700;margin-top:20px;margin-bottom:15px;">
										<span style="border-left:5px solid #19AA8D;padding-left:10px;height:10px;"></span>审核信息
									</div>
									<div>
										<div class="pull-left">
											<if condition="$purchase['creator_info']['thumb_path']">
												<img src="{$purchase['creator_info']['thumb_path']}" style="width:45px;height:45px;margin:10px 0 0 10px;border-radius:50px;">
											<else/>
												<img src="__PUBLIC__/img/moren.png" style="width:45px;height:45px;margin:10px 0 0 10px;border-radius:50px;">
											</if>
										</div>
										<div class="pull-left" style="margin:10px 0 0 10px;">
											<div class="control-label" style="margin-top:2px;font-size:14px;color:#B4B1C2"><a href="javascript:void(0)" rel="{$purchase['creator_role_id']}" class="role_info" style="color: #B4B1C2;">{$purchase['creator_info']['full_name']}</a></div>
											<div class="control-label" style="margin-top:2px;font-size:13px;">{$purchase.create_time|date="Y-m-d H:i",###}</div>
										</div>
										
										<if condition = "$purchase_examine">
											<volist name="check_list" id="vo">
												<div class="pull-left" style="margin-left:10px;margin-top:25px;">
													<span class="fa fa-circle" style="color:#B4B1C2;font-size:12px;"></span>
													<span class="fa fa-circle" style="color:#B4B1C2;font-size:12px;"></span>
													<span class="fa fa-circle" style="color:#B4B1C2;font-size:12px;"></span>
												</div>
												<div class="pull-left" style="margin-left:10px;">
													<if condition = "$vo['user_info']['thumb_path']">
														<img src="{$vo['user_info']['thumb_path']}" style="width:45px;height:45px;margin:10px 0 0 10px;border-radius:50px;" />
													<else />
														<img src="__PUBLIC__/img/moren.png" style="width:45px;height:45px;margin:10px 0 0 10px;border-radius:50px;" />
													</if>
												</div>
												<div class="pull-left" style="margin:10px 0 0 10px;">
													<div class="control-label" style="margin-top:2px;font-size:14px;color:#B4B1C2">
														<a href="javascript:void(0)" rel="{$vo['role_id']}" class="role_info" style="color: #B4B1C2;">{$vo['user_info']['full_name']}</a>
													</div>
													<div class="control-label check_badge" style="margin-top:2px;font-size:13px;">
														<if condition="$purchase['order_id'] && ($purchase['order_id'] gt $vo['order_id'])">
															<span style="color:#19AA8D">通过</span>
														<else />
															<if condition = "$purchase['is_checked'] eq '1' || $purchase['is_checked'] eq '2'">
																<span style="color:#F5715F">结束</span>
															<else />
																<span style="color:#F5CA00">待审</span>
															</if>
														</if>
													</div>
												</div>
											</volist>
										<else />
											<div class="pull-left" style="margin-left:10px;margin-top:25px;">
												<span class="fa fa-circle" style="color:#B4B1C2;font-size:12px;"></span>
												<span class="fa fa-circle" style="color:#B4B1C2;font-size:12px;"></span>
												<span class="fa fa-circle" style="color:#B4B1C2;font-size:12px;"></span>
											</div>
											<div class="pull-left" style="margin-left:10px;">
												<if condition="$purchase['is_checked'] eq 0">
													<img src="__PUBLIC__/img/moren.png" style="width:45px;height:45px;margin:10px 0 0 10px;border-radius:50px;" />
												<else/>
													<empty name="info['examine_role_info']['thumb_path']">
														<img src="__PUBLIC__/img/moren.png" style="width:45px;height:45px;margin:10px 0 0 10px;border-radius:50px;" />
													<else />
														<img src="{$purchase['examine_role_info']['thumb_path']}" style="width:45px;height:45px;margin:10px 0 0 10px;border-radius:50px;" />
													</empty>
												</if>
											</div>
											<div class="pull-left" style="margin:10px 0 0 10px;">
												<div class="control-label" style="margin-top:2px;font-size:14px;color:#B4B1C2">
													<if condition="$purchase['is_checked'] neq 0">
														<a href="javascript:void(0)" rel="{$purchase['examine_role_id']}" class="role_info" style="color: #B4B1C2;">{$purchase['examine_role_info']['full_name']}</a>
													<else/>
														采购单审核员
													</if>
												</div>
												<div class="control-label check_badge" style="margin-top:2px;font-size:13px;">
													<if condition="$purchase['is_checked'] eq 1">
														<span style="color:#19AA8D">通过</span>
													<elseif condition="$purchase['is_checked'] eq 2"/>
														<span style="color:#F5715F">拒绝</span>
													<elseif condition="$purchase['is_checked'] eq 3"/>
														<span style="color:#FF6600">审批中</span>
													<else />
														<span style="color:#F5CA00">待审</span>
													</if>
													<if condition="checkPerByAction('purchase','check') && $purchase['is_checked'] gt 0">
														&nbsp;<a class="backbtn control" style="display:none;" href="{:U('purchase/revokecheck', 'id='.$purchase['purchase_id'])}"><i class="icon-repeat"></i> 撤销</a>
													</if>
												</div>
											</div>
										</if>
										<div style="clear:both"></div>
									</div>
									<div style="margin-top:20px;margin-left:15px;"><a href="javascript:void(0);" id="check_list"><i class="fa fa-history"></i>&nbsp;&nbsp;查看采购单审核历史</a></div>
								</div>
							</div>

						</div>
					</div>
				</div>
				<div style="clear:both;"></div>
			</div>
		</div>
	</div>
</div>
<div style="display:none;" id="dialog-role-info" title="{:L('DIALOG_USER_INFO')}">
	<div class="spiner-example">
		<div class="sk-spinner sk-spinner-three-bounce">
			<div class="sk-bounce1"></div>
			<div class="sk-bounce2"></div>
			<div class="sk-bounce3"></div>
		</div>
	</div>
</div>
<div style="display:none;" id="dialog-check-info" title="采购单审核">
	<form action="{:U('purchase/check')}" id="deny_form" method="post">
		<input name="purchase_id" type="hidden" value="{$purchase['purchase_id']}" />
		<textarea style="width:400px;height:200px;" name="description" placeholder="填写理由(必填)"></textarea>
		<div style="margin-top:10px;margin-right:5px;">
		<a href="javascript:void(0);" onclick="javascript:$('#dialog-check-info').dialog('close');" class="pull-right btn btn-primary">取消</a>
		<button type="submit" name="submit1" value="deny" class="pull-right btn btn-primary" style="margin-right:10px;padding:6px 13px;">确认拒绝</button>&nbsp;&nbsp;
		</div>
	</form>
</div>
<div style="display:none;" id="dialog-check-list" title="审核记录">
	<div class="spiner-example">
		<div class="sk-spinner sk-spinner-three-bounce">
			<div class="sk-bounce1"></div>
			<div class="sk-bounce2"></div>
			<div class="sk-bounce3"></div>
		</div>
	</div>
</div>
<div style="display:none" id="dialog-check-purchase" title="采购单审核">
	<div class="spiner-example">
		<div class="sk-spinner sk-spinner-three-bounce">
			<div class="sk-bounce1"></div>
			<div class="sk-bounce2"></div>
			<div class="sk-bounce3"></div>
		</div>
	</div>
</div>
<link href="__PUBLIC__/css/litebox.css" rel="stylesheet" type="text/css">
<script src="__PUBLIC__/js/litebox.min.js" type="text/javascript"></script>
<script src="__PUBLIC__/js/images-loaded.min.js" type="text/javascript"></script>
<script type="text/javascript">
// 打印按钮。
var preview_page ; // 弹出窗口
$("#print").on('click', function(){
	var is_IE = IEVersion();
	if (is_IE != 'edge' && is_IE != -1) {
		swal('抱歉，IE浏览器暂不支持预览、打印功能', '可换用谷歌，360，edge等浏览器\n（360浏览器须切换极速模式）', 'warning');
		return false;
	}
	var count_tpl = 0;
	$.ajax({
		async: false,
		url: '{:U("template/preview")}',
		data: {object: 'purchase'},
		type: 'POST',
		dataType: 'json',
		success: function(json){
			if (json.count != 0) {
				count_tpl = json.count;
			}
		}
	});
	if (count_tpl < 1) {
		swal('没有可用的采购单模板！', '', 'warning');
		return false;
	}
    preview_page = layer.open({
        type: 2,
        title: '模板预览',
        shadeClose: true,
        area: ['100%', '100%'],
        content: '{:U("template/preview")}&object=purchase&id={$purchase_id}' // iframe的url
    }); 
    $('.layui-layer-title,.layui-layer-close').remove();
});


function IEVersion() {
	var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串  
	var isIE = userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1; //判断是否IE<11浏览器  
	var isEdge = userAgent.indexOf("Edge") > -1 && !isIE; //判断是否IE的Edge浏览器  
	var isIE11 = userAgent.indexOf('Trident') > -1 && userAgent.indexOf("rv:11.0") > -1;
	if (isIE) {
		var reIE = new RegExp("MSIE (\\d+\\.\\d+);");
		reIE.test(userAgent);
		var fIEVersion = parseFloat(RegExp["$1"]);
		if (fIEVersion == 7) {
			return 7;
		} else if (fIEVersion == 8) {
			return 8;
		} else if (fIEVersion == 9) {
			return 9;
		} else if (fIEVersion == 10) {
			return 10;
		} else {
			return 6;//IE版本<=7
		}
	} else if (isEdge) {
		return 'edge';//edge
	} else if (isIE11) {
		return 11; //IE11  
	} else {
		return -1;//不是ie浏览器
	}
}

// 页面加载时执行Tab start
$(function(){
	var thisId = window.location.hash; 
	var atype = thisId.substr(1);
	$('#left_list a[type="'+atype+'"]').tab('show');
});
// 页面加载时执行Tab end
$('#left_list a').click(function (e) {
	var maodian = '#'+$(this).attr('type');
	url_jump(maodian);
});
function url_jump(maodian){
    var purchase_id = "{$purchase['purchase_id']}";;
    var url = "{:U('purchase/view','id=')}"+purchase_id+maodian;
    window.history.replaceState({},0,'http://'+window.location.host+url);
}

var is_receivables = '{$is_receivables}';
$('#is_agree').change(function(){
	var agree_id = $(this).val();
	if(agree_id == 1){
		$('.is_show').show();
		if(is_receivables == 0 || is_receivables == ''){
			$('#pay_times').hide();
		}
	}else{
		$('.is_show').hide();
	}
});
$('.openrecycle').click(function(){
	var is_receivables = $("input[name='is_receivables']:checked").val();
	if(is_receivables == 1){
		$('#pay_times').show();
	}else{
		$('#pay_times').hide();
	}
});
//审核采购单
$("#check_purchase").click(function(){
	var id = $(this).attr('rel');
	$('#dialog-check-purchase').dialog('open');
	$('#dialog-check-purchase').load('{:U("purchase/check","purchase_id=")}'+id);
});
$("#dialog-check-purchase").dialog({
	autoOpen: false,
	modal: true,
	width: 444,
	maxHeight: 450,
	position: ["center",100] ,
	buttons: {
		"确定": function () {
			var is_agree = $('#is_agree').val();
			var openrecycle2 = $('#openrecycle2:checked').val();
			var examine_role_id = $('#examine_role_id').val();
			if (is_agree == 1 && openrecycle2 == 1) {
				if (examine_role_id == '') {
					alert_crm('请选择下一审批人！');
					return false;
				}
			}
			$('#purchase_dialog').submit();
			$(this).dialog("close");
		},
		"取消": function () {
			$(this).dialog("close");
		}
	}
});
//撤销审核
$("#recheck_purchase").click(function(){
	var id = $(this).attr('rel');
	swal({   
		title: "确定要撤销审核吗？",   
		type: "warning",   
		showCancelButton: true,  
		confirmButtonColor: "#DD6B55",   
		confirmButtonText: "确定",   
		closeOnConfirm: false 
	},
	function(){ 
		window.location.href="{:U('purchase/revokeCheck', 'id=')}"+id; 
	});
});

/**
 * 如果是图片时 双击可查看大图
 */
$('.litebox_file').liteBox({
	revealSpeed: 400,
	background: 'rgba(0,0,0,.8)',
	overlayClose: true,
	escKey: true,
	navKey: true,
	errorMessage: '图片加载失败.'
});
var pm_heigth = window.screen.height * 0.57;
var right_heigth = window.screen.height * 0.57;
$('#left-content').css('min-height',pm_heigth+'px');
$('#right-content').css('min-height',right_heigth+'px');
$(".check_badge").hover(function(){
	$(this).find('.control').toggle();
});

$("#dialog-check-list").dialog({
	autoOpen: false,
	modal: true,
	width: 600,
	maxHeight: 400,
	position: ["center",100],
});
$(function(){
	$("#check_list").click(function(){
		$('#dialog-check-list').dialog('open');
		$('#dialog-check-list').load('{:U("Contract/check_list","id=".$purchase["purchase_id"])}');
	});
});
</script>
<script>
if ("{:C('isMobile')}" == "1") {
	width = $('.container').width() * 0.9;
} else {
	width = 800;
}

$("#dialog-role-info").dialog({
    autoOpen: false,
    modal: true,
	width: 650,
	maxHeight:600,
	position: ["center",100]
});
$("#dialog-check-info").dialog({
	autoOpen: false,
	modal: true,
	width: 432,
	maxHeight: 400,
	position: ["center",100],
});
$(function(){
	$(".role_info").click(function(){
		$role_id = $(this).attr('rel');
		$('#dialog-role-info').dialog('open');
		$('#dialog-role-info').load('{:U("user/dialoginfo","id=")}'+$role_id);
	});
	$(".checkbtn").click(function(){
		$('#dialog-check-info').dialog('open');
		$("#dialog_description").focus();
	});
});
</script>
<include file="Public:footer" />	