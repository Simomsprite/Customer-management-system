<form action="{:U('stock/transfer_out')}" id="form_out" method="post">
	<input type="hidden" name="transfer_id" value="{$transfer['transfer_id']}">
	<input type="hidden" name="warehouse_id" value="{$transfer['out_warehouse_id']}">
	<table class="table table-bordered" width="95%">
		<tr style="background-color:#f9fafc;text-align:center;">
			<td style="background-color:#f9fafc;padding:14px;color:#999">商品名称</td>
			<td style="background-color:#f9fafc;padding:14px;color:#999">规格</td>
			<td style="background-color:#f9fafc;padding:14px;color:#999">单位</td>
			<td style="background-color:#f9fafc;padding:14px;color:#999">调拨数量</td>
			<td style="background-color:#f9fafc;padding:14px;color:#999">备注</td>
		</tr>
		<volist name="product_list" id="vo">									
			<tr style="text-align:center;padding:14px;color:#666">
				<td>{$vo['product_name']}</td>
				<td>{$vo['spec']}</td>
				<td>{$vo['unit']}</td>
				<td>
					<?php if ($vo['has_sn']) { ?>
					<!-- 可选择sn -->
						<a href="javascript:void(0);" class="select_SN" hidden="" rel="" name="{$vo['product_name']}({$vo['spec']})" product_info_id="{$vo.product_info_id}" warehouse_id="{$transfer['out_warehouse_id']}" style="display: inline;">
							<span class="label label-success">SN</span>
						</a>
						<input type="hidden" class="sn_ids" name="product_info_list[{$vo.product_info_id}][sn]">
						<input type="number" min="0" max="{$vo['count']}" class="form-control count" name="product_info_list[{$vo.product_info_id}][count]" value="0" style="width: 80px;display: inline-block;" readonly="readonly"> / {$vo['count']}
					<?php } else { ?>
						<input type="number" min="0" max="{$vo['count']}" class="form-control" name="product_info_list[{$vo.product_info_id}][count]" value="{$vo['count']}" style="width: 80px;display: inline-block;" readonly="readonly"> / {$vo['count']}
					<?php } ?>
				</td>
				<td>{$vo['remark']}</td>
			</tr>
		</volist>
	</table>
	<div style="margin: 10px 0;">
		<div style="width: 45%;display: inline-block;">
			出库日期：<input type="text" class="form-control Wdate" style="display: inline-block;width: 250px;" name="update_time" value="{:date('Y-m-d')}" onfocus="WdatePicker({dateFmt:'yyyy-MM-dd'})" required="">
		</div>
		<div style="width: 45%;display: inline-block;">
			出库单号：<input class="form-control" style="display: inline-block;width: 250px;" type="text" name="number" value="{$number}" required >
		</div>
	</div>
	<div>
		<div style="width: 45%;display: inline-block;">
			负责人&#12288;：
			<input type="hidden" name="owner_role_id" value="{:session('role_id')}" required="">
			<input class="form-control" type="text" id="owner_role_id" readonly="true" value="{:session('full_name')}" style="cursor:pointer;display: inline-block;width: 250px;" placeholder="请点击选择" required="">
		</div>
		<div style="width: 45%;display: inline-block;">
			出库备注：<input class="form-control" style="display: inline-block;width: 250px;" type="text" name="remark" placeholder="填写备注">
		</div>
	</div>
</form>

<div style="display:none" id="dialog-select-SN" title="选择SN码">
	<div class="spiner-example">
		<div class="sk-spinner sk-spinner-three-bounce">
			<div class="sk-bounce1"></div>
			<div class="sk-bounce2"></div>
			<div class="sk-bounce3"></div>
		</div>
	</div>
</div>

<div style="display:none" id="dialog-owner_role-list" title="选择负责人">
	<div class="spiner-example">
		<div class="sk-spinner sk-spinner-three-bounce">
			<div class="sk-bounce1"></div>
			<div class="sk-bounce2"></div>
			<div class="sk-bounce3"></div>
		</div>
	</div>
</div>
<script>
	//选择出库SN dialog
	$('#dialog-select-SN').dialog({
		autoOpen: false,
		modal: true,
		width: 800,
		maxHeight: 600,
		position: ["center", 80],
		buttons: {
			"确认": function () {
				var count = Number($('#SN_count').html());
				var surplus = Number($('#SN_select_surplus').html());
				var product_info_id = $('#select_SN_form input[name="product_info_id"]').val();
				if (count > surplus) {
					swal('选择SN码数量超出库可选择数量！', '可选择' + surplus + ',超出' + (count - surplus), 'warning');
					return false;
				}
				SN_arr = [];
				$('#select_SN_form input.SN:checked').each(function (key, val) {
					SN_arr.push($(val).val());
				});
				$('input[name="product_info_list[' + product_info_id + '][sn]"]').val(SN_arr);
				$('input[name="product_info_list[' + product_info_id + '][count]"]').val(SN_arr.length);
				$(this).dialog("close");
			},
			"取消": function () {
				$(this).dialog("close");
			}
		}
	});
	//选择SN【效果同下，多个点击位置】
	$('.count').on('click', function(){
		$(this).parents('td').find('.select_SN').click();
	});
	// 点击选择SN
	$('.select_SN').on('click', function () {
		if ($(this).parent('td').find('.count').attr('max') < 1) {
			swal('无库存', '本仓库该产品库存量为0', 'warning');
			return false;
		}
		var warehouse_id = "{$transfer['out_warehouse_id']}";
		var product_info_id = $(this).attr('product_info_id');
		var name = $(this).attr('name');
		var surplus = $(this).parent('td').find('.count').attr('max');
		var sn_ids = $('input[name="product_info_list[' + product_info_id + '][sn]"]').val();
		$('#dialog-select-SN').dialog('open');
		$('#dialog-select-SN').load('{:U("sales/stockOutSnSelect")}&product_info_id=' + product_info_id + '&name=' + encodeURIComponent(name) + '&surplus=' + surplus + '&sn_ids=' + sn_ids + '&warehouse_id=' + warehouse_id);
	});

	//选择负责人
	$("#dialog-owner_role-list").dialog({
		autoOpen: false,
		modal: true,
		width: 850,
		maxHeight: 500,
		position: ["center", 100],
		buttons: {
			'{:L("OK")}': function () {
				var role_info = $('input[type="radio"].owner:checked');
				$('input[name="owner_role_id"]').val(role_info.val());
				$('#owner_role_id').val(role_info.attr('rel'));
				$(this).dialog('close');
			},
			'{:L("CANCEL")}': function () {
				$(this).dialog('close');
			}
		},
		close: function () {
			$(this).html('');
		}
	});
	$('#owner_role_id').on('click', function () {
		$("#dialog-owner_role-list").dialog('open');
		$("#dialog-owner_role-list").load('{:U("user/listDialog")}&id=' + $('input[name="owner_role_id"]').val());
	});
</script>