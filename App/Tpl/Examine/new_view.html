<include file="Public:header" />
<script type="text/javascript" src="__PUBLIC__/js/PCASClass.js" ></script>
<div class="wrapper wrapper-content animated fadeIn">
	<include file="Public:alert" />
    <div class="row">
	    <div class="col-lg-12">
			<div class="title-bar">
				<div class="row " id="title-show">
					<ul class="nav pull-left" style="margin:0px 10px 0px 20px;">
						<span>
							<img src="__PUBLIC__/img/contract_view_icon.png" style="margin-bottom:9px;" alt="">
						</span>
						<span style="font-size:21px;margin-left:5px">{$examine_status['name']}</span>&nbsp;&nbsp; 
						<if condition="$info['examine_status'] eq 2">
							<span class="badge badge-success check_badge" style="padding:5px 20px;margin-top:-8px;background:#8BC34A;color:#fff;">通过</span>&nbsp;
						<elseif condition="$info['examine_status'] eq 3"/>
							<span class="badge badge-error check_badge" style="color:#fff;padding:5px 20px;margin-top:-8px;background:#F5715F">拒绝</span>&nbsp;
						<elseif condition="$info['examine_status'] eq 1"/>
							<span class="badge badge-error check_badge" style="color:#fff;padding:5px 20px;margin-top:-8px;background:#F5715F">审批中</span>&nbsp;
						<else />
							<span class="badge badge-warning" style="color:#fff;padding:5px 20px;margin-top:-8px;background:#F5CA00">待审</span>
						</if>
					</ul>
					<if condition = "$info['examine_status'] lt 2 || $info['examine_status'] eq 3">
						<a href="{:U('examine/edit','id='.$info['examine_id'].'&type='.$info['type'])}" class="btn btn-outline btn-default pull-right" style="margin-right: 15px;"><i class="fa fa-pencil"></i>&nbsp;&nbsp;编辑</a>&nbsp;&nbsp;
					</if>
					<if condition="$info['examine_status'] lt 2">
						<input type="hidden" id="is_checked" value="1"/>
						<a href="javascript:void(0);" id="check_examine" style="margin-right:15px;" rel2="{$info['type']}" rel="{$info['examine_id']}" class="btn btn-primary pull-right">审核</a>
					</if>
				</div>
			</div>
			<div class="tabs-container" style="border:1px solid #ccc;">
				<div style="padding:15px 0 0 20px;background:#fff;" id="left-content">
					<ul class="nav nav-tabs" id="left_list" style="height:40px;">
						<li class="active"><a href="#tab1" data-toggle="tab" type="tab1">基本信息</a></li>
						<li><a href="#tab2" data-toggle="tab" type="tab2">附件信息</a></li>
					</ul>
					<div class="tab-content ">
						<div class="tab-pane in active " id="tab1">
							<div class="panel-body ">
								<div style="font-size:13px;font-weight:700;margin:15px auto;"><span style="border-left:5px solid #19AA8D;padding-left:10px;height:10px;"></span>基本信息</div>
								<div class="form-horizontal view-group " style="margin-left:-10px;">
									<div class="form-group">
										<label class="col-lg-2 control-label">申请人</label>
				                        <div class="col-lg-4">
				                            <p class="form-p">
				                                <a class="role_info" href="javascript:void(0)" rel="{$info['owner']['role_id']}">{$info['owner']['full_name']}</a>
				                            </p>
				                        </div>
				                        <if condition = "$info['examine_status'] lt 2">
											<label class="col-lg-2 control-label">审批人</label>
											<div class="col-lg-4">
												<p class="form-p">
													<volist name="info['examine']" id="vo1">
														<a class="role_info" href="javascript:void(0)" rel="{$vo1['role_id']}">{$vo1['full_name']}</a>&nbsp;,&nbsp;
													</volist>
												</p>
											</div>
										<else />
											<label class="col-lg-2 control-label">创建时间</label>
					                        <div class="col-lg-4">
					                            <p class="form-p">
					                                <if condition="$info['create_time'] neq 0">{$info.create_time|date='Y-m-d H:i:s',###}</if>
					                            </p>
					                        </div>
										</if>
				                    </div>
				                    <div class="form-group">
										<label class="col-md-2 control-label">申请事由：</label>
										<div class="col-md-8">
											<p class="form-p">
												<span style="color:#333333">{$info['content']}</span>
											</p>
										</div>
									</div>
		                            <div id="list-show" rel="false" class="">
		                            	<php>$j=0;</php>
				                        <volist name="field_list" id="vo" key="k">
				                        <php>$j++;</php>
				                        <?php 
					                        if($vo['form_type'] == 'datetime' && $info[$vo['field']] != 0){
					                            $info[$vo['field']] = date('Y-m-d H:i', $info[$vo['field']]);
					                        }elseif ($vo['form_type'] == 'datetime' && $info[$vo['field']] == 0) {
					                            $info[$vo['field']] = ' ';
					                        }
				                        ?>
				                        <?php if ($k%2 == 0): ?>
				                            <label class="col-lg-2 control-label">{$vo['name']}</label>
				                            <div class="col-lg-4">
				                                <?php if ($vo['field'] != null): ?>
				                                <p class="form-p">
				                                    <span style="color:#{$vo['color']}">{$info[$vo['field']]}</span>
				                                </p>
				                                <?php endif; ?>
				                            </div>
				                        </div>
				                        <?php else: ?>
					                        <div class="form-group">
					                            <label class="col-lg-2 control-label">{$vo['name']}</label>
					                            <div class="col-lg-4">  
					                                <p class="form-p">
					                                    <span style="color:#{$vo['color']}">{$info[$vo['field']]}</span>
					                                </p>
					                            </div>
					                        <?php if (count($field_list) == $j): ?>
					                        	<div class="col-lg-6">
					                            </div>
					                        </div>
					                        <?php endif; ?>                   
				                        <?php endif; ?>
				                        </volist>
				                    </div>
								</div>
								<div style="font-size:13px;font-weight:700;margin-top:20px;margin-bottom:15px;">
									<span style="border-left:5px solid #19AA8D;padding-left:10px;height:10px;"></span>审核信息
								</div>
								<if condition = "$examine_status['option'] eq 1 && !in_array($info['examine_status'],array('2','3'))">
									<div>
										<volist name="step_list" key="k1" id="vo">
											<if condition="$k1 gt 1">
												<div class="pull-left" style="margin-top:32px;margin-left:15px;font-size:22px;color:#ccc;"><i class="fa fa-long-arrow-right" style="font-size:30px;"></i></div>
											</if>
											<div class="pull-left" style="margin-top:20px;">
												<volist name="vo['role_list']" key="key1" id="voo">
													<div class="pull-left">
														<div style="clear:both;">
															<if condition="$voo['thumb_path']">
																<img class="img-circle" style="width:50px;height:50px;border-radius:50%;margin-left:15px;" src="{$voo['thumb_path']}"/>
															<else/>
																<img class="img-circle" style="width:50px;height:50px;border-radius:50%;margin-left:15px;" src="__PUBLIC__/img/avatar_default.png"/>
															</if>
														</div>
														<div style="clear:both;text-align:center;margin-left:15px;margin-top:5px;">{$voo['full_name']}
															<if condition = "$voo['is_checked_name'] eq '待审'">
																<span style="color:#FACB42;">({$voo['is_checked_name']})</span>
															<elseif condition = "$voo['is_checked_name'] eq '同意'" />
																<span style="color:#72CE56;">({$voo['is_checked_name']})</span>
															</if>
														</div>
													</div>
													<if condition = "$key1 lt count($vo['role_list'])">
														<span class="pull-left" style="line-height: 50px;">( {$vo['relation_name']} )</span>
													</if>
												</volist>
											</div>
										</volist>
										<div style="clear:both"></div>
									</div>
								</if>
								<div style="margin-top:20px;margin-left:15px;"><a href="javascript:void(0);" id="check_list"><i class="fa fa-history"></i>&nbsp;&nbsp;查看审批记录</a></div>
							</div>
						</div>
						<div class="tab-pane " id="tab2">
							<div class="panel-body">
								<div class="header1">
									<div class="pull-right">
										<a href="javascript:void(0);" type="button" class="add_file btn btn-primary"><i class="fa fa-upload"></i>&nbsp;&nbsp;上传</a>
									</div>
									<div style="clear:both;"></div>
								</div>
								<table class="table product-table">
									<if condition="$info.file_list eq null">
										<div style="background-color:#fff;"><include file="Public:nodata" /></div>
									<else /> 
										<tr>
											<td>文件名</td>
											<td>大小</td>
											<if condition="C('ismobile') neq 1"><td>上传人</td>
											<td>上传时间</td><td>操作</td></if>
										</tr>
										<volist name="info.file_list" id="vo">
											<tr>
												<td>
													<img src="__PUBLIC__/productImg/{$vo['pic']}" alt="">
													<a <if condition="in_array(getExtension($vo['name']),imgFormat())">class="litebox_file" href="{$vo['file_path']}" data-litebox-group="group-{$info['examine_id']}" title="点击查看大图"<else/>href="javascript:;" file="{$vo.file_path}" filename="{$vo.name}" onclick="filedown(this);"</if>>{$vo.name}</a>
												</td>
												<td>
													{$vo.size}KB
												</td>
												<td>
													<a class="role_info" rel="vo['owner']['role_id']" href="javascript:void(0);">{$vo['owner']['full_name']}</a>
												</td>
												<td>
													<notempty name="vo.create_date">{$vo.create_date|date="Y-m-d H:i",###}</notempty>
												</td>
												<td class="tdleft">
													<if condition = "$info['examine_status'] eq 0">
														<a href="javascript:void(0);" class="del_file" rel="{$vo['file_id']}">{:L('DELETE')}</a>
													</if>
													<a href="javascript:;" file="{$vo.file_path}" filename="{$vo.name}" onclick="filedown(this);">下载</a>
												</td>
											</tr>
										</volist>
									</if>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<div style="display:none" id="dialog-add-examine" title="添加审批">
	<div class="spiner-example">
		<div class="sk-spinner sk-spinner-three-bounce">
			<div class="sk-bounce1"></div>
			<div class="sk-bounce2"></div>
			<div class="sk-bounce3"></div>
		</div>
	</div>
</div>
<div style="display:none;" id="dialog-check-list" title="审核记录">
	<div class="spiner-example">
		<div class="sk-spinner sk-spinner-three-bounce">
			<div class="sk-bounce1"></div>
			<div class="sk-bounce2"></div>
			<div class="sk-bounce3"></div>
		</div>
	</div>
</div>
<div class="" style="display:none;" id="dialog-role-info" title="{:L('EMPLOYEE_INFORMATION')}">
	<div class="spiner-example">
		<div class="sk-spinner sk-spinner-three-bounce">
			<div class="sk-bounce1"></div>
			<div class="sk-bounce2"></div>
			<div class="sk-bounce3"></div>
		</div>
	</div>
</div>
<div class="" style="display:none;" id="dialog-file" title="添加附件">
	<div class="spiner-example">
		<div class="sk-spinner sk-spinner-three-bounce">
			<div class="sk-bounce1"></div>
			<div class="sk-bounce2"></div>
			<div class="sk-bounce3"></div>
		</div>
	</div>
</div>
<link href="__PUBLIC__/css/litebox.css" rel="stylesheet" type="text/css">
<script src="__PUBLIC__/js/litebox.min.js" type="text/javascript"></script>
<script src="__PUBLIC__/js/images-loaded.min.js" type="text/javascript"></script>
<script type="text/javascript">
//页面加载时执行Tab start
$(function(){
	var thisId = window.location.hash; 
	var atype = thisId.substr(1);
	$('#left_list a[type="'+atype+'"]').tab('show');
 });
// 页面加载时执行Tab end
$('#left_list a').click(function (e) {
	var maodian = '#'+$(this).attr('type');
	url_jump(maodian);
});
function url_jump(maodian){
    var examine_id = "{$info['examine_id']}";;
    var url = "{:U('examine/view','id=')}"+examine_id+maodian;
    window.history.replaceState({},0,'http://'+window.location.host+url);
}
/**
 * 附件 如果是图片时 双击可查看大图
 */
$('.litebox_file').liteBox({
  revealSpeed: 400,
  background: 'rgba(0,0,0,.8)',
  overlayClose: true,
  escKey: true,
  navKey: true,
  errorMessage: '图片加载失败.'
});
$("#dialog-check-list").dialog({
	autoOpen: false,
	modal: true,
	width: 600,
	maxHeight: 400,
	position: ["center",100],
});
$("#check_list").click(function(){
	$('#dialog-check-list').dialog('open');
	$('#dialog-check-list').load('{:U("examine/check_list","id=".$info["examine_id"])}');
});
$("#dialog-add-examine").dialog({
	autoOpen: false,
	modal: true,
	width: 750,
	maxHeight: 450,
	position: ["center",100],
	buttons: {
		"确定": function () {
			if($('#openrecycle2').is(":checked")) {
				if($('#examine_role_id').val() == ''){
					alert_crm('下一审批人不能为空！');
					return false;
				}
			}
			$('#form_check').submit();
			$(this).dialog("close");
		},
		"取消": function () {
			$(this).dialog("close");
		}
	}
});
//审核
$("#check_examine").click(function(){
	$('#dialog-add-examine').dialog('open');
	$('#dialog-add-examine').load('{:U("examine/add_examine","id=")}'+$(this).attr('rel')+"&type="+$(this).attr('rel2')); 
});

$(".role_info").click(function(){
	$role_id = $(this).attr('rel');
	$('#dialog-role-info').dialog('open');
	$('#dialog-role-info').load('{:U("user/dialoginfo","id=")}'+$role_id);
});
$("#dialog-role-info").dialog({
    autoOpen: false,
    modal: true,
	width: 600,
	maxHeight: 550,
	position: ["center",100]
});

$("#dialog-file").dialog({
    autoOpen: false,
    modal: true,
	width: 750,
	maxHeight: 400,
	position: ["center",100],
	buttons: {
		"确定": function () {
		   location.reload();
		},
		"取消": function () {
			$(this).dialog("close");
		}
	}
});
$(".add_file").click(function(){
	$('#dialog-file').dialog('open');
	$('#dialog-file').load('{:U("file/add","r=ExamineFile&module=examine&id=".$info["examine_id"])}');
});

$('.del_file').click(function(){
	var file_id = $(this).attr('rel');
	swal({
		title: "您确定要删除这个附件吗？",
		text: "删除后将无法恢复，请谨慎操作！",
		type: "warning",   
		showCancelButton: true,   
		confirmButtonColor: "#DD6B55",   
		confirmButtonText: "是的，我要删除！",
        cancelButtonText:'让我再考虑一下…',
        closeOnConfirm:false,
        closeOnCancel:false
	},
	function(isConfirm){
        if (isConfirm) {
        	$.ajax({
	            type:'get',
	            url: "{:U('file/delete','r=ExamineFile&id=')}"+file_id,
	            async: false,
	            success: function (data) {
					if (data.status == 1) {
						swal("删除成功！", "您已经永久删除了信息！", "success");
						location.reload();
					}else{
						swal({
							title: "操作失败！",
							text:data.info,
							type: "error"
						})
						return false;
					}
	            },
	            dataType: 'json'
	        });
        } else {
            swal("已取消","您取消了删除操作！","error");
        }
    });
});
</script>
<include file="Public:footer" />	