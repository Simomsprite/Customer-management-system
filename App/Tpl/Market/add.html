<include file="Public:header" />
<script src="__PUBLIC__/js/PCASClass.js" type="text/javascript"></script>
<style type="text/css">
.add_title{
	padding-bottom:10px;
	height: 60px;
	margin-bottom:15px;
}
.add_title>span{
	border-bottom: 2px solid #1ab394;
	font-size: 24px;
}
.add_body >div >.full-height-scroll{
	border-right:1px dotted #ccc
}
.add_body_title{
	margin:20px auto 20px auto;
	padding-left: 25px;
}
.add_body_form{
	padding-left: 38px;
}
.add_body_form>form>.form-group{
	margin-bottom: 25px;
}
body{overflow-y:hidden;}
.form-control{
	float:left;
}
.checkbox{float:left;}
.addMember-trigger-button{
	width: 30px;
	height: 30px;
	line-height: 28px;
	color: #fff;
	text-align: center;
	cursor: pointer;
	background-color: #dcdfe3;
	border-radius: 50%;
}
.project-people{
	float:left;
}
.project-people a{
	float:left;
}
#vertical-timeline::before{
        width:0px !important;
    }
.addMember-remove{
	position: relative;
	margin-right:-10px;
	top: -42px;
	right: -28px;
	display:none;
	font-size: 10px;
	line-height: 1;
	color: #fa7a7a;
	cursor: pointer;
	background-color: #fff;
	border-radius: 50%;
}
.re_role_info{
	float:left;
	width:42px;
	height:40px;
}
</style>
<script>
$(function(){
	$(".add_body").height(window.innerHeight-$("#add_body").offset().top-$("#tfoot_div").height()-40);
	$(window).resize(function(){
		$(".add_body").height(window.innerHeight-$("#add_body").offset().top-$("#tfoot_div").height()-40);
	})
})
</script>
<div class="wrapper wrapper-content animated fadeIn col-md-6">
	<include file="Public:alert" />
	<form class="form-horizontal" id="form" role="form" action="{:U('market/add')}" method="post">
	<div class="ibox-content add_body" id="add_body" style="">
		<div class="row">
			<div class="col-md-12 add_body" style="padding-right: 0px;">
				<div class="full-height-scroll">
					<div class="row" >
						<div class="col-md-12 add_body_title">
							<div class="all-inline">
								<span class="sq-tag"></span>
								<div class="text-tag">
									<span>基础信息</span>
								</div>
							</div>
						</div>
						<div class="col-md-11 add_body_form">
							<div class="form-group">
								<label class="col-md-4 control-label">活动负责人：</label>
								<div class="col-md-6">
									<input type="hidden" name="owner_role_id" id="owner_id" value="{$Think.session.role_id}" />
									<input class="form-control required" aria-required="true" type="text" name="owner_role_name" id="owner_name" value="{$Think.session.full_name}"
									 readonly="true" style="cursor:pointer;" title="请点击选择" />
								</div>
								<div class="col-md-2">
									<span style="color:red">*</span>
								</div>
							</div>
							<div class="form-group">
								<label class="col-md-4 control-label">活动参与人：</label>
								<div class="col-md-6">
									<input type="hidden" id="executor_role_ids" name="executor_role_ids" value=",,">
									<dd class="project-people" id="add_executor_role_list">
										<a class="add_executor_role" href="javascript:void(0);" rel="60">
											<div class="addMember-trigger-button">
												<i class="fa fa-plus"></i>
											</div>
										</a>
									</dd>
								</div>
							</div>
							<volist name="field_list['main']" id="vo" key="key">
								<div class="form-group">
									<label class="col-md-4 control-label">{$vo.name}：</label>
									<if condition="$vo['form_type'] == 'textarea'">
										<if condition = "$vo['tip_start'] eq 1">
											<div class="col-md-6">
												{$vo.html}
											</div>
											<div class="col-md-2"><span style="color: red;line-height: 32px;margin-left: 10px;">*</span></div>
										<else/>
											<div class="col-md-8">
												{$vo.html}
											</div>
										</if>
									<elseif condition="$vo['form_type'] == 'address'"/>
										<if condition = "$vo['tip_start'] eq 1">
											<div class="col-md-7">
												{$vo.html}
											</div>
											<div class="col-md-1"><span style="color: red;line-height: 32px;margin-left: 10px;">*</span></div>
										<else/>
											<div class="col-md-8">
												{$vo.html}
											</div>
										</if>
									<elseif condition="$vo['form_type'] == 'box'"/>
										<div class="col-md-6">
											{$vo.html}
										</div>
										<if condition = "$vo['tip_start'] eq 1">
											<div class="col-md-2"><span style="color: red;line-height: 32px;margin-left: 10px;">*</span></div>
										<else/>
											<div class="col-md-2"></div>
										</if>
									<else/>
										<div class="col-md-6">
											{$vo.html}
										</div>
										<if condition = "$vo['tip_start'] eq 1">
											<div class="col-md-2"><span style="color: red;line-height: 32px;margin-left: 10px;">*</span></div>
										<else/>
											<div class="col-md-2"></div>
										</if>
									</if>
								</div>
							</volist>
						</div>
						<div class="col-md-12 add_body_title">
							<div class="all-inline">
								<span class="sq-tag"></span>
								<div class="text-tag">
									<span>附加信息</span>
								</div>
							</div>
						</div>
						<div class="col-md-11 add_body_form">
							<volist name="field_list['data']" id="vo" key="key">
								<div class="form-group">
									<label class="col-md-4 control-label">{$vo.name}：</label>
									<if condition="$vo['form_type'] == 'address' || $vo['form_type'] == 'box' || $vo['form_type'] == 'textarea'">
										<div class="col-md-7">
											{$vo.html}
										</div>
										<if condition = "$vo['tip_start'] eq 1">
											<div class="col-md-1"><span style="color: red;line-height: 32px;margin-left: 10px;">*</span></div>
										<else/>
											<div class="col-md-1"></div>
										</if>
									<else/>
										<div class="col-md-6">
											{$vo.html}
										</div>
										<if condition = "$vo['tip_start'] eq 1">
											<div class="col-md-2"><span style="color: red;line-height: 32px;margin-left: 10px;">*</span></div>
										<else/>
											<div class="col-md-2"></div>
										</if>
									</if>
								</div>
							</volist>
						</div>
						<div class="col-md-1 pull-right">
							<!-- <div style="height: 100%; border-right: 1px dashed gray;">&nbsp;sadf</div> -->
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="tfoot_div" class="clearfix">
		<div class="clearfix" id="tfoot_page">
			<div class="ibox-content" style="border-top: none;">
				<div class="col-sm-offset-2"><button type="submit" id="save_submit" class="btn btn-primary">创建市场活动</button></div>
			</div>
		</div>
	</div>
	</form>
</div>
<div class="" style="display:none;" id="dialog-validate" title="{:L('VALIDATE_COMPANY_RESULT')}">
	<div id="search_leads_content"></div>
	<div id="search_customer_content"></div>
</div>
<div style="display:none;" id="dialog-role-list" title="活动负责人">
	<div class="spiner-example">
		<div class="sk-spinner sk-spinner-three-bounce">
			<div class="sk-bounce1"></div>
			<div class="sk-bounce2"></div>
			<div class="sk-bounce3"></div>
		</div>
	</div>
</div>
<div style="display:none;" id="dialog-executor-role-list" title="活动参与人">
	<div class="spiner-example">
		<div class="sk-spinner sk-spinner-three-bounce">
			<div class="sk-bounce1"></div>
			<div class="sk-bounce2"></div>
			<div class="sk-bounce3"></div>
		</div>
	</div>
</div>
<script type="text/javascript">
function checkinfo(param){
	var field_value = $('#'+param).val();
	if(field_value){
		$.post('{:U("leads/checkinfo")}',
			{
				field_value:field_value,
				field_name:param,
			},
			function(data){
				if(data.status == 1){
					$('#'+param+'-error').remove('');
					$('#'+param).after('<label id="'+param+'-error" class="error" for="source"><i class="fa fa-times-circle"></i></label>');
					$('#'+param+'-error').html('<i class="fa fa-times-circle"></i>'+data.data);
				}else{
					$('#'+param+'-error').remove('');
				}
			},
		'json');
	}
}
$(document).ready(function(){
	$('#save_submit').prop('disabled',false);
		/*form表单验证*/
		$("#form").validate({
			submitHandler:function(form){
	            $('#save_submit').click(function(){
					$('#save_submit').prop('disabled',true);
				});
	            form.submit();
	        }    
		});
});
$("[data-type='nummber']").keyup(function(){
	if(isNaN($(this).val())){
		$(this).val($(this).val().replace(/\D/g,''))
	}
});
$("#dialog-validate").dialog({
	autoOpen: false,
	modal: true,
	width: 400,
	maxHeight: 400,
	buttons: { 
		"确定": function () {
			$(this).dialog("close"); 
		}
	},
	position: ["center", 100]
});
$("#dialog-role-list").dialog({
	autoOpen: false,
	modal: true,
	width: 800,
	maxHeight: 400,
	buttons: {
		"确定": function () {
			var item = $('input:radio[name="owner"]:checked').val();
			var name = $('input:radio[name="owner"]:checked').attr('rel');
			$('#owner_id').val(item);
			$('#owner_name').val(name);
			$(this).dialog("close");
		},
		"取消": function () {
			$(this).dialog("close");
		}
	},
	position: ["center", 100],
	close: function () {
		$(this).html('');
	}
});

$('#dialog-executor-role-list').dialog({
	autoOpen: false,
	modal: true,
	width: 800,
	maxHeight: 600,
	buttons: {
		"确定": function () {
			$('#add_executor_role_list .re_role_info').remove();
			$('#dialog-executor-role-list form').find('.muti_role_id:checked').each(function(key, val){
				var html = $('<div class="re_role_info">\
							<a class="role_info" title="" rel="1" href="javascript:void(0)" style="margin-right:5px;">\
								<img alt="image" class="img-circle" src="">\
							</a>\
							<span class="addMember-remove" rel="1" rel1="owner_roles">\
								<i class="fa fa-minus-circle"></i>\
							</span>\
						</div>');
				var role_id = $(val).val();
				var role_name = $(val).attr('rel');
				var role_pic = $(val).attr('rel1');
				$(html).find('.role_info,.addMember-remove').attr('rel', role_id);
				$(html).find('.role_info').attr('title', role_name);
				$(html).find('img').attr('src', role_pic);
				$('#add_executor_role_list').prepend($(html));
				$(html).hover(function () {
					$(this).find(".addMember-remove").show();
				}, function () {
					$(this).find(".addMember-remove").hide();
				});
				$(html).find('.addMember-remove').on('click', function(){
					$(this).parents('.re_role_info').remove();
					var executor_role_val = $('#executor_role_ids').val();
					$('#executor_role_ids').val(executor_role_val.replace(','+ role_id, ''));
				});
			});
			role_id_to_str();
			$(this).dialog("close"); 
		}
	},
	position: ["center", 100]
});
$(function(){
	$('.form-control.Wdate').val("{:date('Y-m-d')}");
	$('#owner_name').on('click', function(){
		$('#dialog-role-list').dialog('open');
		$('#dialog-role-list').load("{:U('user/listDialog')}");
	});
	$('#name').blur(function(){
		name = $('#name').val();
		var is_check = $(this).attr('is_check');
		if(name != '' && is_check == 1){
			$.post('{:U("leads/check")}',
				{
					name:name
				},
				function(data){
					if(data.data != 0){
						var leads_result = '';
						var customer_result = '';
						if(data.data['leads'].length>0){
							$.each(data.data['leads'], function(k, v){
								leads_result += (k+1)+'、'+v+'</br>';
							});
							$("#search_leads_content").html("<h5>{:L('SAME_LEADS_COMPANY')}</h5>"+leads_result);
						}
						if(data.data['customer'].length>0){
							$.each(data.data['customer'],function(k, v){
								customer_result += (k+1)+'、'+v+'</br>';
							});
							$("#search_customer_content").html("<h5>{:L('SAME_CUSTOMER_COMPANY')}</h5>"+customer_result);
						}
						if(data.data['customer'].length>0 || data.data['leads'].length>0)
							$('#dialog-validate').dialog('open');
					}
				},
			'json');
		}
	});
	$('.add_executor_role').on('click', function () {
		var executor_role_ids = $('#executor_role_ids').val();
		$('#dialog-executor-role-list').dialog('open');
		$('#dialog-executor-role-list').load('{:U("user/mutiListDialog","&check_ids=")}' + executor_role_ids);
	});
});

$('.re_role_info').hover(function(){
	$(this).find(".addMember-remove").show();
}, function(){
	$(this).find(".addMember-remove").hide();
});

function role_id_to_str() {
	var str = ',';
	$('#add_executor_role_list .re_role_info .role_info').each(function(key, val) {
		str += $(val).attr('rel') + ',';
	});
	$('#executor_role_ids').val(str);
}

</script>
<include file="Public:footer" />