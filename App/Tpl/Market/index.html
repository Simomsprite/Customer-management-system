<include file="Public:header" />
<link href="__PUBLIC__/css/litebox.css" rel="stylesheet" type="text/css">
<script src="__PUBLIC__/js/PCASClass.js" type="text/javascript"></script>
<!-- nice-scroll -->
<script src="__PUBLIC__/style/js/plugins/nice-scroll/jquery.nicescroll.min.js" type="text/javascript"></script>
<script type="text/javascript" src="__PUBLIC__/style/js/TableFreeze.js"></script>
<script src="__PUBLIC__/js/pdcrm_more.js" type="text/javascript"></script>
<style>
    body {
        overflow-y: hidden;
    }

    .option {
        padding-left: -30px;
    }

    #oDivL_tab_Test3 {
        background-color: #fff;
    }

    .table {
        max-width: none;
    }
    #right_market_view {
		width: 50% !important;
		right: -60%;
		background-color: #fff;
	    overflow: hidden;
	    position: fixed;
	    top: 0px;
	    z-index: 1009;
	    bottom: 0;
	    box-shadow: 0px 2px 1px #888888;
	}
</style>
<script>
    $(function () {
        var scroll_width = 10;
        // var oTableLH_tab_Test3 = 38;
        $("#table_div").height(window.innerHeight - $("#table_div").offset().top - $("#tfoot_div").height() - parseInt($("#table_container").css("padding-bottom").replace("px", "")) - 10);
        $(window).resize(function () {
            $("#table_div").height(window.innerHeight - $("#table_div").offset().top - $("#tfoot_div").height() - parseInt($("#table_container").css("padding-bottom").replace("px", "")) - 10);
            $("#oDivL_tab_Test3").height($("#table_div").height() - scroll_width - 1).width($("#oTableLH_tab_Test3").width());
            $("#oDivH_tab_Test3").height($("#oTableLH_tab_Test3").height()).width($("#table_div").width() - scroll_width);
        })
        $(".nicescroll").niceScroll({
            cursorcolor: "#999",//#CC0071 光标颜色 
            cursoropacitymax: 0.4, //改变不透明度非常光标处于活动状态（scrollabar“可见”状态），范围从1到0 
            touchbehavior: false, //使光标拖动滚动像在台式电脑触摸设备 
            cursorwidth: scroll_width + "px", //像素光标的宽度 
            cursorborder: "0", //     游标边框css定义 
            cursorborderradius: "3px",//以像素为光标边界半径 
            autohidemode: false, //是否隐藏滚动条 
            zindex: 100,
            background: "#F3F3F5",//滚动条背景色
        });
        $("#tab_Test3").FrozenTable(1, 0, 3);
        $("#oDivL_tab_Test3").height($("#table_div").height() - scroll_width - 1).width($("#oTableLH_tab_Test3").width()).css({ 'zIndex': 9 });
        $("#oDivL_tab_Test3").css({ "background-color": "#fff", "border-right": "1px solid #e7eaec" });
        $("#oTableLH_tab_Test3").css({ "border-right": "1px solid #e7eaec" });
        $("#oDivH_tab_Test3").height($("#oTableLH_tab_Test3").height()).width($("#table_div").width() - scroll_width).css({ 'zIndex': 9 });
    })
</script>
<div class="wrapper wrapper-content">
    <include file="Public:alert" />
    <div class="row">
        <div class="col-md-12">
            <div class="ibox float-e-margins">
                <div class="title-bar" style="position: relative;z-index: 99;">
                    <div class="row  clearfix" id="title-hide" style="display:none;">
                        <ul class="breadcrum pull-left">
                            <li>已选中&nbsp;
                                <span id="icheck_num"></span>&nbsp;项
                            </li>
                            <li class="single_btn">
                                <a href="javascript:void(0)" id="edit_market">
                                    <i class="fa fa-pencil"></i>&nbsp;编辑
                                </a>
                            </li>
                            <li>
                                <a href="javascript:void(0)" class="market_edit_field" field="is_deleted" val="1">
                                    <i class="fa fa-trash"></i>&nbsp;作废
                                </a>
                            </li>
                            <li>
                                <a href="javascript:void(0)" class="market_edit_field" field="is_deleted" val="0">
                                    <i class="fa fa-refresh"></i>&nbsp;恢复
                                </a>
                            </li>
                            <li>
                                <a href="javascript:void(0)" class="market_edit_field" field="is_lock" val="1">
                                    <i class="fa fa-lock"></i>&nbsp;锁定
                                </a>
                            </li>
                            <li>
                                <a href="javascript:void(0)" class="market_edit_field" field="is_lock" val="0">
                                    <i class="fa fa-unlock"></i>&nbsp;解锁
                                </a>
                            </li>
                            <li class="last_li">
                                <big>
                                    <a class="fa fa-times pull-right" id="back-show"></a>
                                </big>
                            </li>
                        </ul>
                    </div>
                    <div class="row " id="title-show">
                        <ul class="nav pull-left" style="margin:2px 0 0 15px;">
                            <a href="{:U('market/add')}" class="btn btn-primary btn-sm pull-left" style="margin-right:8px">
                                <i class="fa fa-plus-circle"></i>&nbsp; 新建市场活动</a>
                        </ul>
                        <form class="form-inline" id="market_search" action="" method="get">
                            <ul class="breadcrum pull-right" style="margin-bottom: 0px">
                                <if condition="$_GET['by'] != 'public'">
                                    <li>
                                        状态：
                                        <div class="input-group" style="margin-right: 10px;margin-bottom: 5px;">
                                            <select class="form-control" name="status">
                                                <option value="">所有</option>
                                                <volist name="market_status_list" id="val">
                                                <option value="{$val}" <?php echo ($_GET['status'] == $val || $_GET['status']['value'] == $val) ? 'selected' : '' ?>>{$val}</option>
                                                </volist>
                                            </select>
                                        </div>
                                    </li>
                                </if>
                                <li>
                                    搜索：
                                    <div class="input-group">
                                        <input type="hidden" name="m" value="market" />
                                        <input type="hidden" name="a" value="index" />
                                        <input type="hidden" name="search" value="name" />
                                        <input id="short_search" type="text" style="width:160px;" placeholder="请输入活动名称" onkeydown='if(event.keyCode==13) {$("#short_search_btn").trigger("click");return false;}'
                                            class="form-control input-sm" name="name" <if condition="$_GET['search'] eq 'name'">value="{$_GET['name']}"</if>/>
                                        <span class="input-group-btn">
                                            <button class="btn btn-default btn-search" id="short_search_btn" type="submit">
                                                <i class="fa fa-search"></i>
                                            </button>
                                        </span>
                                    </div>
                                    &nbsp;&nbsp;
                                    <a title="高级搜索" href="javascript:void(0)" id="search_type" class="btn btn-white btn-bitbucket">
                                        <i class="fa fa-filter" style="color: #D8E3EF;"></i>
                                    </a>
                                </li>
                                <div class="btn-group hidden">
                                    <button data-toggle="dropdown" class="btn btn-primary dropdown-toggle" aria-expanded="false">操作
                                        <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <if condition="checkPerByAction('market','excelimport')">
                                            <li>
                                                <a id="import_excel" class="link" href="javascript:void(0);">
                                                    <i class="fa fa-upload"></i>&nbsp;导入</a>
                                            </li>
                                        </if>
                                        <if condition="checkPerByAction('market','excelexport')">
                                            <li>
                                                <a href="javascript:void(0);" class="link excelExport">
                                                    <i class="fa fa-download"></i>&nbsp;导出</a>
                                            </li>
                                        </if>
                                    </ul>
                                </div>
                            </ul>
                        </form>
                    </div>
                </div>
                <div class="ibox-content clearfix" id="table_container" style="z-index: 1;">
                    <form id="form1" action="" method="post" style="position:relative;">
                        <input type="hidden" name="owner_id" id="hidden_owner_id" value="0" />
                        <input type="hidden" name="message" id="hidden_message" value="0" />
                        <input type="hidden" name="sms" id="hidden_sms" value="0" />
                        <input type="hidden" name="email" id="hidden_email" value="0" />
                        <div id="table_div" class="nicescroll">
                            <table class="table table-hover table-striped table_thead_fixed" id="tab_Test3">
                                <empty name="market_list">
                                    <div style="background-color:#fff;">
                                        <include file="Public:nodata" />
                                    </div>
                                <else/>
                                    <tr id="childNodes_num" class="tabTh">
                                        <td style="width:30px;padding-left: 20px">
                                            <div class="checkbox checkbox-primary">
                                                <input type="checkbox" class="check_all" />
                                                <label for=""></label>
                                            </div>
                                        </td>
                                        <td></td>
                                        <volist name="field_array" id="vo">
                                            <td>{$vo.name}</td>
                                        </volist>
                                        <td>创建人</td>
                                        <td>负责人</td>
                                        <td>参与者</td>
                                    </tr>
                                    <volist name="market_list" id="vo">
                                        <tr class="controls_tr" is-lock="{$vo['is_lock']}" is-del="{$vo['is_deleted']}">
                                            <td style="width: 30px;padding-left: 20px">
                                                <div class="checkbox checkbox-primary">
                                                    <input name="market_id[]" class="check_list" type="checkbox" value="{$vo.market_id}" />
                                                    <label for=""></label>
                                                </div>
                                            </td>
                                            <td style="width: 30px;padding-left: 20px">
                                                <if condition="$vo['is_lock'] == '1'">
                                                    <a href="javascript:void(0);" title="已锁定，不可编辑。">
                                                        <span class="fa fa-lock" style="font-size:16px;color:orange"></span>
                                                    </a>
                                                </if>
                                            </td>
                                            <volist name="field_array" id="v">
                                                <td>
                                                    <if condition="$v['field'] == 'name'">
                                                        <a href="javascript:void(0);" class="market_view" rel="{$vo['market_id']}">{$vo[$v['field']]}</a>
                                                    <elseif condition="$v['form_type'] == 'datetime'" />
                                                        {:date('Y-m-d', $vo[$v['field']])}
                                                    <else />
                                                        {$vo[$v['field']]}
                                                    </if>
                                                </td>
                                            </volist>
                                            <td>
                                                <a class="role_info" rel="{$vo['creator_role_id']}">{$vo['creator_role_name']}</a>
                                            </td>
                                            <td>
                                                <a class="role_info" rel="{$vo['owner_role_id']}">{$vo['owner_role_name']}</a>
                                            </td>
                                            <td>
                                                <?php $executor_role_str = ''; ?>
                                                <volist name="vo.executor_role_list" key="key" id="val">
                                                    <?php 
                                                        if ($key == 4) break;
                                                        $executor_role_str .= '<a class="role_info" rel="'. $val .'">'. $user_list[$val]['full_name'] .'</a> &nbsp;';
                                                     ?>
                                                </volist>
                                                <?php if (count($vo['executor_role_list']) == 4) $executor_role_str .= '&nbsp;...'; ?>
                                                {$executor_role_str}
                                            </td>
                                        </tr>
                                    </volist>
                                </empty>
                            </table>
                        </div>
                        <div id="tfoot_div" class="clearfix">
                            <div class="clearfix" id="tfoot_page">
                                <if condition="$_GET['search']">
                                    <span class="pull-left" style="margin-left:25px;margin-top:10px;">本次搜索结果
                                        <span style="color:#F8AC59"> {$count} </span>条数据
                                        <a href="{:U('market/index')}" class="btn" style="background:#fff;border:1px solid #ccc;margin-left:10px;color:#999;"
                                            id="clearnumber">清除搜索条件</a>
                                    </span>
                                </if>
                                {$page}
                                <include file="Public:listrows" />
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="dialog-role-list2" style="display:none" title="选择负责人">
    <div class="spiner-example">
        <div class="sk-spinner sk-spinner-three-bounce">
            <div class="sk-bounce1"></div>
            <div class="sk-bounce2"></div>
            <div class="sk-bounce3"></div>
        </div>
    </div>
</div>
<div style="display:none;" id="dialog-role-info" title="员工信息">
    <div class="spiner-example">
        <div class="sk-spinner sk-spinner-three-bounce">
            <div class="sk-bounce1"></div>
            <div class="sk-bounce2"></div>
            <div class="sk-bounce3"></div>
        </div>
    </div>
</div>
<div style="display:none" id="dialog-field-search" title="高级搜索">
	<form class="form-inline" id="searchForm" action="" method="get">
        <input type="hidden" name="m" value="market" />
        <input type="hidden" name="a" value="index"/>
        <input type="hidden" name="search" value="search">
		<div id="search_add" style="width:650px;float:left;">
			<empty name="fields_search">
				<div id="con_search_1" style="float:left;width:650px;margin:0 10px 0 10px;">
					<ul class="nav pull-left" style="margin:0px 0 0 23px;width:650px;">
						<li class="pull-left">
							<select id="field_1" style="width:auto" class="form-control input-sm field_name new-select" onchange="changeCondition(1)" >
								<volist name="field_list" id="v">
									<if condition="$v['field'] neq 'market_owner_id'">
									<option class="{$v['form_type']}" value="{$v['field']}" rel="market" <if condition = "$_GET['search'] eq '' && $v['field'] eq 'name'">selected="selected"</if>>{$v['name']}</option>
									</if>
								</volist>
							</select>&nbsp;&nbsp;
						</li>
						<li class="pull-left" id="conditionContent_1">
						</li>
						<li class="pull-left" id="searchContent_1">
						</li>
					</ul>
				</div>
				<?php $max_key = 1;?>
			<else />
				<volist name="fields_search" key="key1" id="vo">
					<div id="con_search_{$key1}" style="float:left;width:650px;margin:10px 10px 0 10px;">
                        <?php
                            if ($key1 != 1) {
                                $margin_left = 5;
                         ?>
                        <div id="rem_{$key1}" class="pull-left" style="line-height:30px;">
                            <a href="javascript:void(0);" class="rem_search" rel="{$key1}" title="移除">
                                <span class="fa fa-times-circle"></span>
                            </a>
                        </div>&nbsp;
                        <?php
                            } else {
                                $margin_left = 23;
                            }
                         ?>
						<ul class="nav pull-left" style="margin:0px 0 0 {$margin_left}px;width:620px;">
							<li class="pull-left">
                                <select id="field_{$key1}" style="width:auto" class="form-control input-sm field_name new-select" onchange="changeCondition({$key1})">
                                    <volist name="field_list" id="v">
                                        <if condition="$v['field'] neq 'market_owner_id'">
                                            <option class="{$v['form_type']}" value="{$v['field']}" rel="market" <if condition="$_GET['search'] eq '' && $v['field'] eq 'name'">selected="selected"</if>>{$v['name']}</option>
                                        </if>
                                    </volist>
                                </select>&nbsp;&nbsp;
                            </li>
                            <script>
                                $(function(){
									$('#field_{$key1}').val('{$vo["field"]}');
                                    $('#field_{$key1}').change();
                                    setTimeout(function(){
                                        if ('{$vo["form_type"]}' == 'address'){
                                            $('#condition_{$key1}').val('{$vo["condition"]}');
                                            $('#searchContent_{$key1}').find('#{$vo["field"]}_state').val('{$vo["state"]}');
                                            $('#searchContent_{$key1}').find('#{$vo["field"]}_state').change();
                                            $('#searchContent_{$key1}').find('#{$vo["field"]}_city').val('{$vo["city"]}');
                                            $('#searchContent_{$key1}').find('#{$vo["field"]}_city').change();
                                            $('#searchContent_{$key1}').find('#{$vo["field"]}_area').val('{$vo["area"]}');
                                            $('#search_{$key1}').val('{$vo["value"]}');
                                        } else if ('{$vo["form_type"]}' == 'datetime') {
                                            $('#searchContent_{$key1}').find('#start_{$key1}').val('{$vo["start"]}');
                                            $('#searchContent_{$key1}').find('#end_{$key1}').val('{$vo["end"]}');
                                        } else if ('{$vo["form_type"]}' == 'box') {
                                            $('#search_{$key1}').val('{$vo["value"]}');
                                        } else if ('{$vo["form_type"]}' == 'role') {
                                            $('#conditionContent_{$key1}').find('select').val('{$vo["condition"]}');
                                            $('#searchContent_{$key1}').find('select').val('{$vo["value"]}');
                                            $('#searchContent_{$key1}').find('select').change();
                                        } else if ('{$vo["form_type"]}' == 'role_s') {
                                            $('#condition_{$key1}').val('{$vo["condition"]}');
                                            $('#inp_executor_role_ids_{$key1}').val('{$vo["value"]}');
                                            $('#inp_executor_role_ids_{$key1}').next().val('{$full_name_str}');
                                        } else {
                                            $('#condition_{$key1}').val('{$vo["condition"]}');
                                            $('#search_{$key1}').val('{$vo["value"]}');
                                        }
                                    }, 1);
								});
                            </script>
							<li class="pull-left" id="conditionContent_{$key1}">
							</li>
							<li class="pull-left" id="searchContent_{$key1}" style="margin-left:5px;">
							</li>
                        </ul>
					</div>
					<?php $max_key = $key1;?>
				</volist>
			</empty>
		</div>
		<div class="clearfix"></div>
		<div style="margin-left: 35px;margin-top:10px;"><a href="javascript:void(0);" style="display: -moz-stack;margin: 30px 0px 0px; font-size: 12px; color: rgb(62, 133, 233);" id="add_btn">+添加筛选条件</a>
		</div>
	</form>
</div>
<div style="display:none;" id="dialog_search_executor_roles" title="选择活动参与人">
    <div class="spiner-example">
        <div class="sk-spinner sk-spinner-three-bounce">
            <div class="sk-bounce1"></div>
            <div class="sk-bounce2"></div>
            <div class="sk-bounce3"></div>
        </div>
    </div>
</div>
<div id="right_market_view">
    <!--the css for jquery.mCustomScrollbar-->
    <link rel="stylesheet" href="__PUBLIC__/emoji/css/jquery.mCustomScrollbar.min.css" />
    <!--the css for this plugin-->
    <link rel="stylesheet" href="__PUBLIC__/emoji/css/jquery.emoji.css" />
    <!--(Optional) the js for jquery.mCustomScrollbar's addon-->
    <script src="__PUBLIC__/emoji/js/jquery.mousewheel-3.0.6.min.js"></script>
    <!--the js for jquery.mCustomScrollbar-->
    <script src="__PUBLIC__/emoji/js/jquery.mCustomScrollbar.min.js"></script>
    <!--the js for this plugin-->
    <script src="__PUBLIC__/emoji/js/jquery.emoji.js"></script>

    <div class="sidebar-container" id="sidebar-container">

    </div>
</div>
<script type="text/javascript">
    //鼠标点击空白处，隐藏右侧滑出
    document.onmousedown = function (event) {
        if ($(".litebox-overlay").length > 0) return;
        if ($("#dialog_open").val() == 1) return;
        if (event.target.className == 'right-sidebar-toggle-task') return;

        var div = document.getElementById("right_market_view");
        var x = event.clientX;
        var y = event.clientY;
        var divx1 = div.offsetLeft;
        var divy1 = div.offsetTop;
        var divx2 = div.offsetLeft + div.offsetWidth;
        var divy2 = div.offsetTop + div.offsetHeight;
        if (x < divx1 || x > divx2 || y < divy1 || y > divy2) {
            if ($("#right_market_view").css('right') == '0px') {
                $("#right_market_view").animate({ right: '-60%' }, 400);
            }
        }
    }
    function checkNumberOrFloat (self) {
        var form_type = $(self).attr('form-type');
        var val = $(self).val();
        if (form_type == 'number') {
            var patt = /^[0-9]*$/;
            var msg = '仅支持输入整数';
        } else {
            var patt = /^[0-9]+(.[0-9]{1,2})?$/;
            var msg = '仅支持输入小数点后最多两位的数字';
        }
        var res = patt.test(val);
        if (!res) {
            $(self).parent('li').addClass('has-error');
            $(self).after('<span class="text-danger number_error_msg">' + msg + '</span>');
        } else {
            $(self).parent('li').removeClass('has-error');
            $(self).next('.number_error_msg').remove();
        }
    }
    $(function(){
        $('#field_1').change(); // 高级搜索初始化
        $('.market_view').on('click', function(){
            $(".check_all").prop('checked', false);
            $('input.check_list').each(function (key, val) {
                if ($(val).is(':checked')) $(val).click();
            });
            $(this).parents('tr').find('td').eq(0).find('input').click();
            var market_id = $(this).attr('rel');
            if ($("#right_market_view").css('right') != '0px') {
                $("#right_market_view").animate({ right: '0px' }, 600);
            }
            $('#sidebar-container').load("{:U('market/view','market_id=')}" + market_id);
        });
        var v_market_id = '{$v_market_id}';
        if (v_market_id) {
            $("#right_market_view").animate({ right: '0px' }, 600);
            $('#sidebar-container').load("{:U('market/view','market_id=')}" + v_market_id);
            window.history.pushState({}, 0, "{:U('market/index')}");
        }
        // 编辑
        $('#edit_market').on('click', function(){
            var market_id = $('input.check_list:checked').val();
            location.href = '{:U("market/edit")}&market_id=' + market_id;
        })
        // 作废
        $('.market_edit_field').on('click', function () {
            var field = $(this).attr('field');
            var val = $(this).attr('val');
            var ids = new Array();
            $('input.check_list:checked').each(function (key, val) {
                ids.push($(val).val());
            });
            ids = ids.join(',');
            $.ajax({
                url: '{:U("market/edit")}',
                data: {market_id: ids, field: field, value: val},
                type: 'POST',
                dataType: 'JSON',
                success: function (json) {
                    if (json.status == 1) {
                        if (field == 'is_lock' || field == 'is_deleted') {
                            text = (val == 1) ? ((field == 'is_lock') ? '锁定后不可编辑' : '作废后不可编辑，合同添加/编辑页不在展示') : '';
                            swal({
                                title: json.msg,
                                text: text,
                                type: 'success'
                            }, function () {
                                history.go(0);
                            });
                        } else {
                            swal(json.msg, '', 'success');
                        }
                    } else {
                        swal(json.msg, '', 'error');
                    }
                }
            });
        });
        // 状态筛选
        $('#market_search select').on('change', function () {
            $('#market_search').submit();
        });
        // 高级搜索
        $('#search_type').on('click', function () {
            $("#dialog-field-search").dialog('open');
        });
    });

    $("#dialog-field-search").dialog({
        autoOpen: false,
        modal: true,
        width: 700,
        height: 500,
        position: ["center", 100],
        buttons: {
            "确定": function () {
                doh();
                if (dosearch == 1) {
                    $(this).dialog("close");
                }
            },
            "取消": function () {
                $(this).dialog("close");
            }
        }
    });
    /*添加筛选条件*/
    var m = {$max_key};
    $('#add_btn').click(function () {
        m += 1;
        $('#search_add').append('<div id="con_search_'+ m +'" style="float:left;width:650px;margin:10px 0px 0 10px;">\
                <div id="rem_'+ m + '" class="pull-left" style="line-height:30px;"><a href="javascript:void(0);" class="rem_search" rel="' + m +'" title="移除"><span class="fa fa-times-circle"></span></a></div>\
                <ul class= "nav pull-left" style="margin:0px 0 0 4px;width:627px;">\
                    <li class="pull-left" style="margin-right: 8px;">\
                        <select id="field_'+ m +'" style="width:auto" class="form-control input-sm field_name new-select" onchange="changeCondition('+ m +')" >\
                            <volist name="field_list" id="v">\
                                <if condition="$v['field'] neq 'market_owner_id'">\
                                <option class="{$v['form_type']}" value="{$v['field']}" rel="market" <if condition = "$_GET['search'] eq '' && $v['field'] eq 'name'">selected="selected"</if>>{$v['name']}</option>\n\ 
                                </if>\
                            </volist>\
                        </select >\
                    </li >\
                    <li class="pull-left" id="conditionContent_'+ m +'">\
                    </li>\
                    <li class="pull-left" id="searchContent_'+ m +'">\
                    </li>\
                </ul>\
            </div>');
        $('#field_' + m).change();
    });
    $(document).on('click', '.rem_search', function () {
        var num = $(this).attr('rel');
        $('#con_search_' + num).remove();
    });

    // 参与人编辑
    function search_executor_role(self){
        var sid = $(self).attr('rel');
        $('#dialog_search_executor_roles').dialog({
            autoOpen: false,
            modal: true,
            width: 800,
            maxHeight: 400,
            draggable: false,
            buttons: {
                "确定": function () {
                    var checked = $(".muti_role_id:checked");
                    var ids = new Array(),
                    full_names = new Array();
                    $.each(checked, function(key, val){
                        ids.push($(val).val());
                        full_names.push($(val).attr('rel'));
                    });
                    $('#inp_executor_role_ids_'+ sid).val(',' + ids.join(',') + ',');
                    $(self).val(full_names.join(','));
                    $(this).dialog("close");
                },
                "取消": function () {
                    var checked = $(".muti_role_id:checked");
                    var ids = new Array(),
                        full_names = new Array();
                    $.each(checked, function (key, val) {
                        ids.push($(val).val());
                        full_names.push($(val).attr('rel'));
                    });
                    $('#inp_executor_role_ids_' + sid).val(',' + ids.join(',') + ',');
                    $(self).val(full_names.join(','));
                    $(this).dialog("close");
                }
            },
            position: ["center", 100],
            close: function () {
                $('#dialog_open').val(1);
                $(this).html('');
            }
        });
        var ids = $('#inp_executor_role_ids_'+sid).val();
        $('#dialog_search_executor_roles').dialog('open');
        $('#dialog_search_executor_roles').load("{:U('user/mutiListDialog')}&check_ids=" + ids);
    }

    // 筛选重复判断
    var dosearch = 1;
    function doh() {
        var ary = new Array();
        var field_name = '';
        var is_submit = 1;
        $('.field_name').each(function (k, v) {
            field_name = $(this).find("option:selected").val();
            if (jQuery.inArray(field_name, ary) >= 0) {
                is_submit = 0;
                alert('筛选条件中有重复项！');
                dosearch = 0;
                return false;
            }
            ary[k] = field_name;
        })
        if (is_submit == 1) {
            $("#searchForm").submit();
        }
    }

    /*让复选框默认取消选择*/
    $(':checkbox').prop('checked', false);
    $('[data-toggle="tooltip"]').tooltip({ html: true });

    $(".controls_tr").mouseenter(function () {
        $(this).find(".controls").show();
    }).mouseleave(function () {
        $(this).find(".controls").hide();
    });

    // 员工详情
    $("#dialog-role-info").dialog({
        autoOpen: false,
        modal: true,
        width: 800,
        minHeight: 400,
        position: ["center", 100],
        close: function () {
            $('#dialog_open').val(0);
        }
    });
    $(".role_info").click(function () {
        $role_id = $(this).attr('rel');
        $('#dialog-role-info').dialog('open');
        $('#dialog-role-info').load('{:U("user/dialoginfo","id=")}' + $role_id);
    });
   $("#dialog-role-list2").dialog({
        autoOpen: false,
        modal: true,
        width: 800,
        maxHeight: 400,
        buttons: {
            "确定": function () {
                var item = $('input:radio[name="owner"]:checked').val();
                var name = $('input:radio[name="owner"]:checked').parent().next().html();
                var leads_id = $("#leads_id").val();
                var dialog_leads_id = $("#dialog_leads_id").val();
                if (dialog_leads_id) {
                    var item = $('input:radio[name="owner"]:checked').val();
                    var name = $('input:radio[name="owner"]:checked').attr('rel');
                    $('#owner_name').val(name);
                    $('#owner_id').val(item);
                } else {
                    $.ajax({
                        type: 'get',
                        url: 'index.php?m=leads&a=change_customer&id=' + leads_id + '&role_id=' + item,
                        async: false,
                        success: function (data) {
                            if (data.status == 1) {
                                swal("转换成功！", "您已经成功将该线索转换为客户！", "success");
                                history.go(0);
                            } else {
                                alert_crm(data.info);
                                history.go(0);
                            }
                        },
                        dataType: 'json'
                    });
                }
                $(this).dialog("close");
            },
            "取消": function () {
                $(this).dialog("close");
            }
        },
        position: ["center", 100],
        close: function () {
            $('#dialog-role-list2').html('');
        }
    });
</script>
<include file="Public:footer" />